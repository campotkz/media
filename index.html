<!doctype html>
<html lang="ru">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1,maximum-scale=1,user-scalable=no" />
  <title>GULYWOOD ERP | –ö–∞–ª–µ–Ω–¥–∞—Ä—å —Å—ä—ë–º–æ–∫</title>

  <script src="https://telegram.org/js/telegram-web-app.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>

  <style>
    :root{
      --font-sans: -apple-system, BlinkMacSystemFont, "SF Pro Display", "SF Pro Text", system-ui, sans-serif;
      --font-mono: ui-monospace, "SF Mono", Menlo, Monaco, monospace;
      --fs-title: 17px; --fs-body: 13px; --fs-caption: 11px;
      --hit: 44px; --r-3: 20px; --r-pill: 999px;
      --text: rgba(255,255,255,.92); --muted: rgba(255,255,255,.68);
      --accent: rgba(122,162,255,1); --accent-fill: rgba(122,162,255,.20);
      --bg-0: #070812; --glass: rgba(20,22,30,.38);
    }
    *{ box-sizing:border-box; }
    body{
      margin:0; font-family: var(--font-sans); color: var(--text); font-size: var(--fs-body);
      background: linear-gradient(180deg, #0a0b10 0%, var(--bg-0) 100%);
      min-height:100vh; overflow-x:hidden; -webkit-font-smoothing: antialiased;
    }
    .wrap{ max-width: 1120px; margin: 0 auto; padding: 16px; display:grid; grid-template-columns: 1.2fr 1fr; gap: 16px; }
    @media (max-width: 980px){ .wrap{ grid-template-columns:1fr; } }
    .card{ border-radius: var(--r-3); background: var(--glass); border: 1px solid rgba(255,255,255,.1); backdrop-filter: blur(22px); overflow:hidden; }
    .head{ padding: 12px 16px; display:flex; align-items:center; justify-content:space-between; background: rgba(20,22,30,.26); border-bottom: 1px solid rgba(255,255,255,.08); }
    .grid{ display:grid; grid-template-columns: repeat(7, 1fr); gap: 8px; padding: 16px; }
    .dow{ display:grid; grid-template-columns: repeat(7, 1fr); text-align:center; font-size: 10px; color: var(--muted); padding: 0 16px; margin-top:10px; }
    .day{ min-height: 76px; padding: 12px; border-radius: 16px; border: 1px solid rgba(255,255,255,.1); background: rgba(255,255,255,.05); cursor:pointer; position:relative; }
    .day.sel{ border-color: var(--accent); background: rgba(122,162,255,1); color: #000; }
    .day.out{ opacity: 0.3; }
    .day.today{ outline: 2px dashed rgba(255,204,102,.55); outline-offset: 2px; }
    .badge{ position:absolute; top:8px; right:8px; width:6px; height:6px; border-radius:50%; background: var(--accent); }
    .day.sel .badge { background: #000; }
    .side{ padding: 16px; display:flex; flex-direction:column; gap: 16px; }
    .list{ border-radius: 16px; overflow:hidden; background: rgba(255,255,255,.04); border: 1px solid rgba(255,255,255,.1); }
    .item{ padding: 12px 16px; border-bottom: 1px solid rgba(255,255,255,.08); cursor:pointer; }
    form{ display:grid; gap: 12px; padding: 16px; background: rgba(255,255,255,.04); border-radius: 16px; border: 1px solid rgba(255,255,255,.1); }
    input, textarea{ width:100%; background: rgba(0,0,0,0.2); border: 1px solid rgba(255,255,255,.12); color: #fff; padding: 12px; border-radius: 12px; font-family: inherit; outline:none; }
    .row2{ display:grid; grid-template-columns: 1fr 1fr; gap: 12px; }
    button{ min-height: var(--hit); padding: 0 16px; border-radius: var(--r-pill); border: 1px solid rgba(255,255,255,.1); background: rgba(255,255,255,.06); color: #fff; font-weight: 600; cursor:pointer; }
    button.primary{ background: var(--accent-fill); border-color: var(--accent); }
    pre{ background: rgba(0,0,0,.18); padding: 16px; border-radius: 16px; font-family: var(--font-mono); font-size: 12px; white-space: pre-wrap; border: 1px solid rgba(255,255,255,.1); }
  </style>
</head>

<body>
  <div class="wrap">
    <div class="card">
      <div class="head">
        <div style="font-size:17px; font-weight:700;">üé¨ GULYWOOD ERP</div>
        <div style="display:flex; gap:6px;">
          <button onclick="changeMonth(-1)">‚óÄ</button>
          <button onclick="goToday()">–°–µ–≥–æ–¥–Ω—è</button>
          <button onclick="changeMonth(1)">‚ñ∂</button>
        </div>
      </div>
      <div style="padding: 16px 16px 0;">
        <div id="monthLabel" style="font-size:18px; font-weight:600; text-transform:capitalize;">‚Äî</div>
      </div>
      <div class="dow"><div>–ü–ù</div><div>–í–¢</div><div>–°–†</div><div>–ß–¢</div><div>–ü–¢</div><div>–°–ë</div><div>–í–°</div></div>
      <div class="grid" id="grid"></div>
      <div style="padding: 16px; border-top: 1px solid rgba(255,255,255,0.1); display:flex; gap:10px;">
        <button class="primary" onclick="copyToClipboard()" style="flex:1;">–°–∫–æ–ø–∏—Ä–æ–≤–∞—Ç—å –≤—ã–≥—Ä—É–∑–∫—É –¥–Ω—è</button>
        <button onclick="exportToTxt()">–°–∫–∞—á–∞—Ç—å .txt</button>
      </div>
    </div>

    <div class="card">
      <div class="head">
        <div style="font-weight:600;">üìÖ <span id="selectedLabel">‚Äî</span></div>
        <button onclick="clearForm()">–ù–æ–≤–∞—è —Å—ä–µ–º–∫–∞</button>
      </div>
      <div class="side">
        <div class="list" id="eventList"></div>

        <form id="shootForm">
          <div class="row2">
            <input id="project" placeholder="–ü—Ä–æ–µ–∫—Ç/–∫–ª–∏–µ–Ω—Ç" required />
            <input id="location" placeholder="–õ–æ–∫–∞—Ü–∏—è" />
          </div>
          <div class="row2">
            <input id="callTime" type="time" title="Call Time" />
            <input id="wrapTime" type="time" title="Wrap Time" />
          </div>
          <input id="address" placeholder="–ê–¥—Ä–µ—Å / 2GIS –ª–∏–Ω–∫" />
          <input id="contact" placeholder="–ö–æ–Ω—Ç–∞–∫—Ç (–ò–º—è + —Ç–µ–ª)" />
          <textarea id="deliverables" placeholder="–¢–µ—Ö–Ω–∏—á–µ—Å–∫–æ–µ –∑–∞–¥–∞–Ω–∏–µ" rows="3"></textarea>
          <textarea id="crew" placeholder="–ö–æ–º–∞–Ω–¥–∞" rows="3"></textarea>
          <textarea id="schedule" placeholder="–ü–ª–∞–Ω / —Ç–∞–π–º–∏–Ω–≥" rows="3"></textarea>
          <textarea id="gear" placeholder="–¢–µ—Ö–Ω–∏–∫–∞" rows="2"></textarea>
          <textarea id="notes" placeholder="–ü—Ä–∏–º–µ—á–∞–Ω–∏—è" rows="2"></textarea>

          <div style="display:flex; gap:10px;">
            <button type="button" id="delBtn" onclick="deleteEntry()" style="color:#ff6b6b; flex:1; display:none;">–£–¥–∞–ª–∏—Ç—å</button>
            <button type="submit" class="primary" style="flex:2;">–°–æ—Ö—Ä–∞–Ω–∏—Ç—å –≤ –æ–±–ª–∞–∫–æ</button>
          </div>
        </form>

        <pre id="preview">‚Äî</pre>
      </div>
    </div>
  </div>

  <script>
    const S_URL = "https://waekzofajzqcpoeldhkt.supabase.co";
    const S_KEY = "sb_publishable_XVByRUkaKbM-11ChwOd2Aw_y24CSb4V";
    const supabase = window.supabase.createClient(S_URL, S_KEY);
    const tg = window.Telegram.WebApp;
    tg.expand();

    let allEvents = [];
    let selectedDate = new Date();
    let currentMonth = new Date(new Date().getFullYear(), new Date().getMonth(), 1);
    let editingId = null;

    const toISO = d => `${d.getFullYear()}-${String(d.getMonth()+1).padStart(2,'0')}-${String(d.getDate()).padStart(2,'0')}`;

    async function loadData() {
      const { data, error } = await supabase.from('shoots').select('*');
      if (!error) { allEvents = data || []; render(); }
    }

    document.getElementById('shootForm').onsubmit = async (e) => {
      e.preventDefault();
      const payload = {
        id: editingId || Math.random().toString(36).substring(2, 15),
        date: toISO(selectedDate),
        project: document.getElementById('project').value,
        location: document.getElementById('location').value,
        callTime: document.getElementById('callTime').value,
        wrapTime: document.getElementById('wrapTime').value,
        address: document.getElementById('address').value,
        contact: document.getElementById('contact').value,
        deliverables: document.getElementById('deliverables').value,
        crew: document.getElementById('crew').value,
        schedule: document.getElementById('schedule').value,
        gear: document.getElementById('gear').value,
        notes: document.getElementById('notes').value
      };
      const { error } = await supabase.from('shoots').upsert(payload);
      if (!error) {
        tg.HapticFeedback.notificationOccurred('success');
        clearForm();
        await loadData();
      }
    };

    async function deleteEntry() {
      if(!editingId || !confirm("–£–¥–∞–ª–∏—Ç—å?")) return;
      await supabase.from('shoots').delete().eq('id', editingId);
      clearForm();
      await loadData();
    }

    function render() {
      const grid = document.getElementById('grid');
      grid.innerHTML = '';
      const today = new Date();
      
      document.getElementById('monthLabel').textContent = currentMonth.toLocaleDateString('ru', {month:'long', year:'numeric'});
      document.getElementById('selectedLabel').textContent = selectedDate.toLocaleDateString('ru');

      const start = new Date(currentMonth.getFullYear(), currentMonth.getMonth(), 1);
      const offset = (start.getDay() + 6) % 7;
      const dateIter = new Date(start);
      dateIter.setDate(start.getDate() - offset);

      for(let i=0; i<42; i++) {
        const d = new Date(dateIter);
        const iso = toISO(d);
        const count = allEvents.filter(e => e.date === iso).length;
        const isSelected = iso === toISO(selectedDate);
        
        const cell = document.createElement('div');
        cell.className = `day ${d.getMonth() !== currentMonth.getMonth() ? 'out' : ''} ${isSelected ? 'sel' : ''} ${iso === toISO(today) ? 'today' : ''}`;
        cell.innerHTML = `<div>${d.getDate()}</div>${count ? '<div class="badge"></div>' : ''}`;
        cell.onclick = () => { selectedDate = d; editingId = null; document.getElementById('shootForm').reset(); render(); };
        grid.appendChild(cell);
        dateIter.setDate(dateIter.getDate() + 1);
      }

      const listDiv = document.getElementById('eventList');
      const dayEvents = allEvents.filter(e => e.date === toISO(selectedDate));
      listDiv.innerHTML = dayEvents.length ? '' : '<div style="padding:10px; opacity:0.5;">–ù–µ—Ç —Å—ä–µ–º–æ–∫</div>';
      
      dayEvents.forEach(ev => {
        const item = document.createElement('div');
        item.className = 'item';
        item.innerHTML = `<b>${ev.project}</b><br><small>${ev.callTime || '--:--'} ‚Ä¢ ${ev.location || ''}</small>`;
        item.onclick = () => {
          editingId = ev.id;
          document.getElementById('project').value = ev.project || "";
          document.getElementById('location').value = ev.location || "";
          document.getElementById('callTime').value = ev.callTime || "";
          document.getElementById('wrapTime').value = ev.wrapTime || "";
          document.getElementById('address').value = ev.address || "";
          document.getElementById('contact').value = ev.contact || "";
          document.getElementById('deliverables').value = ev.deliverables || "";
          document.getElementById('crew').value = ev.crew || "";
          document.getElementById('schedule').value = ev.schedule || "";
          document.getElementById('gear').value = ev.gear || "";
          document.getElementById('notes').value = ev.notes || "";
          document.getElementById('delBtn').style.display = 'block';
        };
        listDiv.appendChild(item);
      });

      document.getElementById('preview').textContent = buildExportText();
    }

    function buildExportText() {
      const dayList = allEvents.filter(e => e.date === toISO(selectedDate));
      if(!dayList.length) return "–°–º–µ–Ω –Ω–µ—Ç.";
      let lines = [`üé¨ –°–™–Å–ú–û–ß–ù–´–ô –î–ï–ù–¨ ‚Äî ${selectedDate.toLocaleDateString('ru-RU')}`];
      dayList.forEach((e, i) => {
        lines.push(`\n‚Äî ‚Äî ‚Äî\nüé• –ü—Ä–æ–µ–∫—Ç #${i+1}\n–ü—Ä–æ–µ–∫—Ç: ${e.project}\nCall: ${e.callTime}\n–õ–æ–∫–∞—Ü–∏—è: ${e.location}\n–ö–æ–º–∞–Ω–¥–∞: ${e.crew}\n–ó–∞–º–µ—Ç–∫–∏: ${e.notes}`);
      });
      return lines.join("\n");
    }

    function copyToClipboard() { navigator.clipboard.writeText(buildExportText()); alert("–°–∫–æ–ø–∏—Ä–æ–≤–∞–Ω–æ!"); }
    function exportToTxt() { 
      const blob = new Blob([buildExportText()], {type: "text/plain"});
      const a = document.createElement("a");
      a.href = URL.createObjectURL(blob); a.download = `GULYWOOD_${toISO(selectedDate)}.txt`; a.click();
    }

    function changeMonth(dir) { currentMonth.setMonth(currentMonth.getMonth() + dir); render(); }
    function goToday() { selectedDate = new Date(); currentMonth = new Date(selectedDate.getFullYear(), selectedDate.getMonth(), 1); render(); }
    function clearForm() { editingId = null; document.getElementById('shootForm').reset(); document.getElementById('delBtn').style.display = 'none'; }

    loadData();
  </script>
</body>
</html>
