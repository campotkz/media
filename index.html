<!doctype html>
<html lang="ru">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1,maximum-scale=1,user-scalable=no" />
  <title>GULYWOOD ERP | Calendar</title>

  <script src="https://telegram.org/js/telegram-web-app.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>

  <style>
    :root {
      --font-sans: -apple-system, BlinkMacSystemFont, "SF Pro Display", "SF Pro Text", system-ui, sans-serif;
      --accent: rgba(122,162,255,1);
      --bg-0: #070812;
      --glass: rgba(255,255,255,0.06);
      --text: rgba(255,255,255,0.92);
      --radius: 16px;
    }

    * { box-sizing: border-box; }
    body {
      margin: 0; font-family: var(--font-sans); color: var(--text);
      background: radial-gradient(circle at top right, rgba(122,162,255,0.15), var(--bg-0));
      min-height: 100vh; font-size: 14px; -webkit-font-smoothing: antialiased;
    }

    .wrap { max-width: 1000px; margin: 0 auto; padding: 16px; display: grid; grid-template-columns: 1.2fr 1fr; gap: 16px; }
    @media (max-width: 850px) { .wrap { grid-template-columns: 1fr; } }

    .card {
      background: rgba(20, 22, 30, 0.6); border: 1px solid rgba(255,255,255,0.1);
      border-radius: var(--radius); padding: 16px; backdrop-filter: blur(20px);
      box-shadow: 0 10px 30px rgba(0,0,0,0.5);
    }

    .title-row { display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px; }
    .title { font-size: 18px; font-weight: 700; letter-spacing: -0.5px; }

    /* Calendar Grid */
    .month-nav { display: flex; justify-content: space-between; align-items: center; margin-bottom: 15px; }
    .grid { display: grid; grid-template-columns: repeat(7, 1fr); gap: 6px; }
    .dow { display: grid; grid-template-columns: repeat(7, 1fr); text-align: center; font-size: 10px; color: gray; margin-bottom: 5px; }
    
    .day {
      aspect-ratio: 1/1; display: flex; flex-direction: column; align-items: center; justify-content: center;
      border-radius: 10px; border: 1px solid rgba(255,255,255,0.05); cursor: pointer; transition: 0.2s; position: relative;
    }
    .day:hover { background: rgba(255,255,255,0.05); }
    .day.sel { border-color: var(--accent); background: rgba(122,162,255,0.15); box-shadow: 0 0 15px rgba(122,162,255,0.2); }
    .day.out { opacity: 0.3; }
    .badge { position: absolute; top: 4px; right: 4px; width: 6px; height: 6px; background: var(--accent); border-radius: 50%; }

    /* Form & UI */
    form { display: grid; gap: 10px; margin-top: 15px; }
    input, textarea {
      width: 100%; background: rgba(0,0,0,0.3); border: 1px solid rgba(255,255,255,0.15);
      color: white; padding: 12px; border-radius: 10px; font-size: 14px; outline: none;
    }
    input:focus { border-color: var(--accent); }
    .btn-group { display: flex; gap: 8px; margin-top: 10px; }
    button {
      padding: 12px; border-radius: 12px; border: none; font-weight: 600; cursor: pointer; transition: 0.2s;
    }
    button.primary { background: var(--accent); color: #000; width: 100%; }
    button.secondary { background: rgba(255,255,255,0.1); color: white; }
    
    .event-item {
      padding: 12px; border-radius: 10px; background: rgba(255,255,255,0.03);
      margin-bottom: 8px; border-left: 3px solid var(--accent); cursor: pointer;
    }
    .event-item:hover { background: rgba(255,255,255,0.08); }

    .loading-overlay {
      position: fixed; inset: 0; background: var(--bg-0); display: flex; 
      align-items: center; justify-content: center; z-index: 100; transition: 0.5s;
    }
  </style>
</head>

<body>
  <div id="loader" class="loading-overlay">üé• GULYWOOD...</div>

  <div class="wrap">
    <div class="card">
      <div class="title-row">
        <div class="title">üé¨ –°–º–µ–Ω–∞</div>
        <div id="userName" style="font-size:12px; opacity:0.6;"></div>
      </div>
      
      <div class="month-nav">
        <button class="secondary" onclick="moveMonth(-1)">‚óÄ</button>
        <div id="monthDisplay" style="font-weight:600; font-size:16px;"></div>
        <button class="secondary" onclick="moveMonth(1)">‚ñ∂</button>
      </div>

      <div class="dow"><div>–ü–ù</div><div>–í–¢</div><div>–°–†</div><div>–ß–¢</div><div>–ü–¢</div><div>–°–ë</div><div>–í–°</div></div>
      <div class="grid" id="calendarGrid"></div>
    </div>

    <div class="card">
      <div class="title-row">
        <div class="title">üìÖ <span id="selectedDateText"></span></div>
        <button class="secondary" onclick="resetForm()">–ù–æ–≤–∞—è</button>
      </div>

      <div id="dayEvents"></div>

      <form id="shootForm">
        <input id="project" placeholder="–ü—Ä–æ–µ–∫—Ç (–Ω–∞–ø—Ä. Medetfilm)" required />
        <input id="location" placeholder="–õ–æ–∫–∞—Ü–∏—è" />
        <div style="display:flex; gap:10px;">
          <input id="callTime" type="time" title="Call Time" />
          <input id="wrapTime" type="time" title="Wrap Time" />
        </div>
        <textarea id="crew" placeholder="–ö–æ–º–∞–Ω–¥–∞ (–ø–æ —Å—Ç—Ä–æ–∫–∞–º)" rows="3"></textarea>
        <textarea id="notes" placeholder="–ó–∞–º–µ—Ç–∫–∏ / –¢–µ—Ö–Ω–∏–∫–∞" rows="2"></textarea>
        
        <button type="submit" class="primary">–°–û–•–†–ê–ù–ò–¢–¨ –í –û–ë–õ–ê–ö–û</button>
        <button type="button" id="delBtn" style="background:rgba(255,50,50,0.2); color:#ff5e5e; display:none;" onclick="deleteRecord()">–£–¥–∞–ª–∏—Ç—å –∑–∞–ø–∏—Å—å</button>
      </form>
    </div>
  </div>

  <script>
    // 1. –ü–û–î–ö–õ–Æ–ß–ï–ù–ò–ï –¢–í–û–ò–• –ö–õ–Æ–ß–ï–ô
    const S_URL = "https://waekzofajzqcpoeldhkt.supabase.co";
    const S_KEY = "sb_publishable_XVByRUkaKbM-11ChwOd2Aw_y24CSb4V";
    const supabaseClient = supabase.createClient(S_URL, S_KEY);

    // Telegram Init
    const tg = window.Telegram.WebApp;
    tg.expand();
    if(tg.initDataUnsafe.user) {
      document.getElementById('userName').textContent = tg.initDataUnsafe.user.first_name;
    }

    let events = [];
    let viewMonth = new Date(new Date().getFullYear(), new Date().getMonth(), 1);
    let selectedDate = new Date();
    let editingId = null;

    const fmtISO = d => d.toISOString().split('T')[0];

    // 2. –ó–ê–ì–†–£–ó–ö–ê –î–ê–ù–ù–´–•
    async function fetchData() {
      const { data, error } = await supabaseClient.from('shoots').select('*');
      if (!error) {
        events = data || [];
        render();
        document.getElementById('loader').style.opacity = '0';
        setTimeout(() => document.getElementById('loader').style.display = 'none', 500);
      }
    }

    // 3. –°–û–•–†–ê–ù–ï–ù–ò–ï
    document.getElementById('shootForm').onsubmit = async (e) => {
      e.preventDefault();
      tg.MainButton.showProgress();

      const payload = {
        id: editingId || Math.random().toString(36).substring(2, 15),
        date: fmtISO(selectedDate),
        project: document.getElementById('project').value,
        location: document.getElementById('location').value,
        callTime: document.getElementById('callTime').value,
        wrapTime: document.getElementById('wrapTime').value,
        crew: document.getElementById('crew').value,
        notes: document.getElementById('notes').value
      };

      const { error } = await supabaseClient.from('shoots').upsert(payload);

      if (!error) {
        tg.HapticFeedback.notificationOccurred('success');
        resetForm();
        await fetchData();
      } else {
        alert("–û—à–∏–±–∫–∞: " + error.message);
      }
    };

    // 4. –£–î–ê–õ–ï–ù–ò–ï
    async function deleteRecord() {
      if(!editingId || !confirm("–£–¥–∞–ª–∏—Ç—å —Å–º–µ–Ω—É?")) return;
      const { error } = await supabaseClient.from('shoots').delete().eq('id', editingId);
      if(!error) {
        resetForm();
        await fetchData();
      }
    }

    // 5. –û–¢–†–ò–°–û–í–ö–ê
    function render() {
      const grid = document.getElementById('calendarGrid');
      grid.innerHTML = '';
      
      document.getElementById('monthDisplay').textContent = viewMonth.toLocaleString('ru', { month: 'long', year: 'numeric' });
      document.getElementById('selectedDateText').textContent = selectedDate.toLocaleDateString('ru');

      const start = new Date(viewMonth.getFullYear(), viewMonth.getMonth(), 1);
      const offset = (start.getDay() + 6) % 7;
      const dateIter = new Date(start);
      dateIter.setDate(start.getDate() - offset);

      for(let i=0; i<42; i++) {
        const current = new Date(dateIter);
        const iso = fmtISO(current);
        const hasEvent = events.some(e => e.date === iso);
        
        const dayEl = document.createElement('div');
        dayEl.className = `day ${current.getMonth() !== viewMonth.getMonth() ? 'out' : ''} ${iso === fmtISO(selectedDate) ? 'sel' : ''}`;
        dayEl.innerHTML = `<span>${current.getDate()}</span>${hasEvent ? '<div class="badge"></div>' : ''}`;
        dayEl.onclick = () => { selectedDate = current; resetForm(); render(); };
        grid.appendChild(dayEl);
        dateIter.setDate(dateIter.getDate() + 1);
      }

      // –°–ø–∏—Å–æ–∫ —Å–æ–±—ã—Ç–∏–π –¥–Ω—è
      const dayBox = document.getElementById('dayEvents');
      const todayEvents = events.filter(e => e.date === fmtISO(selectedDate));
      dayBox.innerHTML = todayEvents.length ? '' : '<div style="opacity:0.4; padding:10px;">–°–º–µ–Ω –Ω–µ—Ç</div>';
      
      todayEvents.forEach(ev => {
        const item = document.createElement('div');
        item.className = 'event-item';
        item.innerHTML = `<b>${ev.project}</b><br><small>${ev.callTime || '??:??'} | ${ev.location || '–ù–µ—Ç –ª–æ–∫–∞—Ü–∏–∏'}</small>`;
        item.onclick = () => {
          editingId = ev.id;
          document.getElementById('project').value = ev.project;
          document.getElementById('location').value = ev.location;
          document.getElementById('callTime').value = ev.callTime;
          document.getElementById('wrapTime').value = ev.wrapTime;
          document.getElementById('crew').value = ev.crew;
          document.getElementById('notes').value = ev.notes;
          document.getElementById('delBtn').style.display = 'block';
        };
        dayBox.appendChild(item);
      });
    }

    function moveMonth(dir) { viewMonth.setMonth(viewMonth.getMonth() + dir); render(); }
    function resetForm() {
      editingId = null;
      document.getElementById('shootForm').reset();
      document.getElementById('delBtn').style.display = 'none';
    }

    fetchData();
  </script>
</body>
</html>
