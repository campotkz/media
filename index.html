<!doctype html>
<html lang="ru">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1,maximum-scale=1,user-scalable=no" />
  <title>GULYWOOD ERP | –ö–∞–ª–µ–Ω–¥–∞—Ä—å —Å—ä—ë–º–æ–∫</title>

  <script src="https://telegram.org/js/telegram-web-app.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>

  <style>
    /* –¢–í–û–ô –û–†–ò–ì–ò–ù–ê–õ–¨–ù–´–ô –î–ò–ó–ê–ô–ù (Apple-ish) */
    :root{
      --font-sans: -apple-system, BlinkMacSystemFont, "SF Pro Display", "SF Pro Text", system-ui, sans-serif;
      --font-mono: ui-monospace, "SF Mono", Menlo, Monaco, Consolas, monospace;
      --fs-title: 17px; --fs-subtitle: 15px; --fs-body: 13px; --fs-callout: 12px; --fs-caption: 11px;
      --hit: 44px; --r-3: 20px; --r-pill: 999px;
      --text: rgba(255,255,255,.92); --muted: rgba(255,255,255,.68); --muted2: rgba(255,255,255,.52);
      --accent: rgba(122,162,255,1); --accent-fill: rgba(122,162,255,.20); --accent-stroke: rgba(122,162,255,.62);
      --bg-0: #070812; --glass: rgba(20,22,30,.38); --ease: cubic-bezier(.2,.8,.2,1);
    }
    *{ box-sizing:border-box; }
    body{
      margin:0; font-family: var(--font-sans); color: var(--text); font-size: var(--fs-body);
      background: radial-gradient(900px 650px at 20% 15%, rgba(122,162,255,.25) 0%, transparent 58%), linear-gradient(180deg, #0a0b10 0%, var(--bg-0) 100%);
      min-height:100vh; overflow-x:hidden; -webkit-font-smoothing: antialiased;
    }
    .wrap{ position:relative; max-width: 1120px; margin: 0 auto; padding: 16px; display:grid; grid-template-columns: 1.2fr 1fr; gap: 16px; }
    @media (max-width: 980px){ .wrap{ grid-template-columns:1fr; } }
    .card{ position:relative; border-radius: var(--r-3); background: var(--glass); border: 1px solid rgba(255,255,255,.1); backdrop-filter: blur(22px); box-shadow: 0 18px 60px rgba(0,0,0,.45); }
    .head{ padding: 12px 16px; display:flex; align-items:center; justify-content:space-between; background: rgba(20,22,30,.26); border-bottom: 1px solid rgba(255,255,255,.08); }
    .grid{ display:grid; grid-template-columns: repeat(7, 1fr); gap: 8px; padding: 16px; }
    .dow{ display:grid; grid-template-columns: repeat(7, 1fr); text-align:center; font-size: 10px; color: var(--muted2); padding: 0 16px; margin-top:10px; text-transform: uppercase; }
    .day{ min-height: 76px; padding: 12px; border-radius: 16px; border: 1px solid rgba(255,255,255,.10); background: rgba(255,255,255,.05); cursor:pointer; position:relative; transition: background .14s var(--ease); }
    .day.sel{ border-color: var(--accent); background: rgba(122,162,255,.15); box-shadow: inset 0 1px 0 rgba(255,255,255,.08); }
    .day.out{ opacity:.3; }
    .day.today{ outline: 2px dashed rgba(255,204,102,.55); outline-offset: 2px; }
    .badge{ position:absolute; top:8px; right:8px; width:6px; height:6px; border-radius:50%; background: var(--accent); }
    .side{ padding: 16px; display:flex; flex-direction:column; gap: 16px; }
    .list{ border-radius: 16px; overflow:hidden; background: rgba(255,255,255,.04); border: 1px solid rgba(255,255,255,.1); }
    .item{ padding: 12px 16px; border-bottom: 1px solid rgba(255,255,255,.08); cursor:pointer; background: rgba(255,255,255,.03); }
    form{ display:grid; gap: 12px; padding: 16px; background: rgba(255,255,255,.04); border-radius: 16px; border: 1px solid rgba(255,255,255,.1); }
    label{ display:grid; gap: 4px; font-size: var(--fs-caption); font-weight: 600; color: var(--muted); }
    input, textarea{ width:100%; background: rgba(0,0,0,.18); border: 1px solid rgba(255,255,255,.12); color: #fff; padding: 10px; border-radius: 12px; font-family: inherit; font-size: 13px; outline:none; }
    .row2{ display:grid; grid-template-columns: 1fr 1fr; gap: 12px; }
    button{ min-height: var(--hit); padding: 0 16px; border-radius: var(--r-pill); border: 1px solid rgba(255,255,255,.1); background: rgba(255,255,255,.06); color: #fff; font-weight: 600; cursor:pointer; transition: transform 0.1s; }
    button:active{ transform: scale(0.98); }
    button.primary{ background: var(--accent-fill); border-color: var(--accent); }
    pre{ background: rgba(0,0,0,.18); padding: 16px; border-radius: 16px; font-family: var(--font-mono); font-size: 11px; white-space: pre-wrap; border: 1px solid rgba(255,255,255,.1); color: var(--muted); }
  </style>
</head>

<body>
  <div class="wrap">
    <div class="card">
      <div class="head">
        <div class="title">üé¨ GULYWOOD ERP</div>
        <div style="display:flex; gap:6px;">
          <button onclick="moveMonth(-1)">‚óÄ</button>
          <button onclick="goToday()">–°–µ–≥–æ–¥–Ω—è</button>
          <button onclick="moveMonth(1)">‚ñ∂</button>
        </div>
      </div>
      <div style="padding: 16px 16px 0;">
        <div id="monthLabel" style="font-size:18px; font-weight:600; text-transform:capitalize;">‚Äî</div>
      </div>
      <div class="dow"><div>–ü–ù</div><div>–í–¢</div><div>–°–†</div><div>–ß–¢</div><div>–ü–¢</div><div>–°–ë</div><div>–í–°</div></div>
      <div class="grid" id="grid"></div>
      <div style="padding: 16px; border-top: 1px solid rgba(255,255,255,0.1); display:flex; gap:10px;">
        <button class="primary" onclick="copyToClipboard()" style="flex:1;">–°–∫–æ–ø–∏—Ä–æ–≤–∞—Ç—å –≤—ã–≥—Ä—É–∑–∫—É –¥–Ω—è</button>
        <button onclick="downloadText()">–°–∫–∞—á–∞—Ç—å .txt</button>
      </div>
    </div>

    <div class="card">
      <div class="head">
        <div style="font-weight:600;">üìÖ <span id="selectedLabel">‚Äî</span></div>
        <button onclick="clearForm()">–ù–æ–≤–∞—è —Å—ä–µ–º–∫–∞</button>
      </div>
      <div class="side">
        <div class="list" id="eventList"></div>

        <form id="shootForm">
          <div class="row2">
            <label>–ü—Ä–æ–µ–∫—Ç<input id="project" placeholder="–ù–∞–ø—Ä: Fujifilm" required /></label>
            <label>–õ–æ–∫–∞—Ü–∏—è<input id="location" placeholder="–°—Ç—É–¥–∏—è / –ì–æ—Ä—ã" /></label>
          </div>
          <div class="row2">
            <label>Call<input id="callTime" type="time" /></label>
            <label>Wrap<input id="wrapTime" type="time" /></label>
          </div>
          <label>–ê–¥—Ä–µ—Å/–ª–∏–Ω–∫<input id="address" placeholder="2GIS –∏–ª–∏ Google Maps" /></label>
          <label>–ö–æ–Ω—Ç–∞–∫—Ç<input id="contact" placeholder="–ò–º—è + —Ç–µ–ª–µ—Ñ–æ–Ω" /></label>
          
          <label>–¢–µ—Ö–Ω–∏—á–µ—Å–∫–æ–µ –∑–∞–¥–∞–Ω–∏–µ<textarea id="deliverables" placeholder="–§–æ—Ä–º–∞—Ç, —Å–º—ã—Å–ª—ã, —Ä–µ—Ñ–µ—Ä–µ–Ω—Å—ã..." rows="3"></textarea></label>
          <label>–ö–æ–º–∞–Ω–¥–∞<textarea id="crew" placeholder="–û–ø–µ—Ä–∞—Ç–æ—Ä: ...&#10;–ó–≤—É–∫: ..." rows="3"></textarea></label>
          <label>–ü–ª–∞–Ω / —Ç–∞–π–º–∏–Ω–≥<textarea id="schedule" placeholder="10:00 ‚Äî –∏–Ω—Ç–µ—Ä–≤—å—é..." rows="3"></textarea></label>
          <label>–¢–µ—Ö–Ω–∏–∫–∞<textarea id="gear" placeholder="–ö–∞–º–µ—Ä–∞, —Å–≤–µ—Ç, –∑–≤—É–∫..." rows="2"></textarea></label>
          <label>–ü—Ä–∏–º–µ—á–∞–Ω–∏—è<textarea id="notes" placeholder="–ü–∞—Ä–∫–æ–≤–∫–∞, –ø—Ä–æ–ø—É—Å–∫..." rows="2"></textarea></label>

          <div style="display:flex; gap:10px;">
            <button type="button" id="delBtn" onclick="deleteEntry()" style="color:#ff6b6b; flex:1; display:none;">–£–¥–∞–ª–∏—Ç—å</button>
            <button type="submit" class="primary" style="flex:2;">–°–û–•–†–ê–ù–ò–¢–¨ –í –û–ë–õ–ê–ö–û</button>
          </div>
        </form>

        <div>
          <div style="font-weight:600; margin-bottom:8px;">–ü—Ä–µ–≤—å—é –≤—ã–≥—Ä—É–∑–∫–∏</div>
          <pre id="preview">‚Äî</pre>
        </div>
      </div>
    </div>
  </div>

  <script>
    // 1. –ö–û–ù–§–ò–ì –û–ë–õ–ê–ö–ê (–¢–í–û–ò –ö–õ–Æ–ß–ò)
    const S_URL = "https://waekzofajzqcpoeldhkt.supabase.co";
    const S_KEY = "sb_publishable_XVByRUkaKbM-11ChwOd2Aw_y24CSb4V";
    const supabaseClient = window.supabase.createClient(S_URL, S_KEY);
    
    const tg = window.Telegram.WebApp;
    tg.expand();

    let allEvents = [];
    let selectedDate = new Date();
    let currentMonth = new Date(new Date().getFullYear(), currentMonth = new Date().getMonth(), 1);
    let editingId = null;

    const toISO = d => `${d.getFullYear()}-${String(d.getMonth()+1).padStart(2,'0')}-${String(d.getDate()).padStart(2,'0')}`;

    // 2. –ó–ê–ì–†–£–ó–ö–ê –î–ê–ù–ù–´–•
    async function loadData() {
      const { data, error } = await supabaseClient.from('shoots').select('*');
      if (!error) {
        allEvents = data || [];
        render();
      }
    }

    // 3. –°–û–•–†–ê–ù–ï–ù–ò–ï
    document.getElementById('shootForm').onsubmit = async (e) => {
      e.preventDefault();
      const payload = {
        id: editingId || Math.random().toString(36).substring(2, 15),
        date: toISO(selectedDate),
        project: document.getElementById('project').value,
        location: document.getElementById('location').value,
        callTime: document.getElementById('callTime').value,
        wrapTime: document.getElementById('wrapTime').value,
        address: document.getElementById('address').value,
        contact: document.getElementById('contact').value,
        deliverables: document.getElementById('deliverables').value,
        crew: document.getElementById('crew').value,
        schedule: document.getElementById('schedule').value,
        gear: document.getElementById('gear').value,
        notes: document.getElementById('notes').value
      };

      const { error } = await supabaseClient.from('shoots').upsert(payload);
      if (!error) {
        tg.HapticFeedback.notificationOccurred('success');
        clearForm();
        await loadData();
        alert("–°–æ—Ö—Ä–∞–Ω–µ–Ω–æ –≤ GULYWOOD DB! ‚úÖ");
      }
    };

    // 4. –£–î–ê–õ–ï–ù–ò–ï
    async function deleteEntry() {
      if(!editingId || !confirm("–£–¥–∞–ª–∏—Ç—å –≤—ã–±—Ä–∞–Ω–Ω—É—é —Å—ä—ë–º–∫—É?")) return;
      const { error } = await supabaseClient.from('shoots').delete().eq('id', editingId);
      if(!error) {
        clearForm();
        await loadData();
      }
    }

    // 5. –ì–ï–ù–ï–†–ê–¶–ò–Ø –¢–ï–ö–°–¢–ê (–ö–ê–ö –í –û–†–ò–ì–ò–ù–ê–õ–ï)
    function normalizeBullets(text) {
      if(!text) return "";
      return text.split("\n").map(s => s.trim()).filter(Boolean).map(s => "‚Ä¢ " + s).join("\n");
    }

    function buildExportText() {
      const list = allEvents.filter(e => e.date === toISO(selectedDate));
      if(!list.length) return "–ù–∞ —ç—Ç–æ—Ç –¥–µ–Ω—å —Å—ä—ë–º–æ–∫ –Ω–µ—Ç.";
      
      let lines = [`üé¨ –°–™–Å–ú–û–ß–ù–´–ô –î–ï–ù–¨ ‚Äî ${selectedDate.toLocaleDateString('ru-RU', {day:'2-digit', month:'long', year:'numeric'})}`];
      lines.push(`–ì–æ—Ä–æ–¥/—á–∞—Å–æ–≤–æ–π –ø–æ—è—Å: –ê–ª–º–∞—Ç—ã (Asia/Almaty)\n`);

      list.forEach((e, i) => {
        lines.push(`‚Äî ‚Äî ‚Äî\nüé• –ü—Ä–æ–µ–∫—Ç #${i+1}`);
        if(e.project) lines.push(`–ü—Ä–æ–µ–∫—Ç/–∫–ª–∏–µ–Ω—Ç: ${e.project}`);
        if(e.callTime) lines.push(`Call: ${e.callTime}`);
        if(e.location) lines.push(`–õ–æ–∫–∞—Ü–∏—è: ${e.location}`);
        if(e.address) lines.push(`–ê–¥—Ä–µ—Å: ${e.address}`);
        if(e.contact) lines.push(`–ö–æ–Ω—Ç–∞–∫—Ç: ${e.contact}`);
        if(e.deliverables) lines.push(`\n–¢–ó:\n${normalizeBullets(e.deliverables)}`);
        if(e.crew) lines.push(`\n–ö–æ–º–∞–Ω–¥–∞:\n${normalizeBullets(e.crew)}`);
        if(e.schedule) lines.push(`\n–ü–ª–∞–Ω/—Ç–∞–π–º–∏–Ω–≥:\n${normalizeBullets(e.schedule)}`);
        if(e.gear) lines.push(`\n–¢–µ—Ö–Ω–∏–∫–∞:\n${normalizeBullets(e.gear)}`);
        if(e.notes) lines.push(`\n–ü—Ä–∏–º–µ—á–∞–Ω–∏—è: ${e.notes}`);
        lines.push("");
      });
      lines.push("‚úÖ –ï—Å–ª–∏ –º–µ–Ω—è–µ—Ç—Å—è –ø–ª–∞–Ω ‚Äî –ø–∏—à–µ–º –≤ –æ–±—â–∏–π —á–∞—Ç —Å—Ä–∞–∑—É.");
      return lines.join("\n");
    }

    // 6. –û–¢–†–ò–°–û–í–ö–ê –ö–ê–õ–ï–ù–î–ê–†–Ø (42 –Ø–ß–ï–ô–ö–ò)
    function render() {
      const grid = document.getElementById('grid');
      grid.innerHTML = '';
      const today = new Date();
      
      document.getElementById('monthLabel').textContent = currentMonth.toLocaleDateString('ru', {month:'long', year:'numeric'});
      document.getElementById('selectedLabel').textContent = selectedDate.toLocaleDateString('ru', {day:'2-digit', month:'long', year:'numeric'});

      const start = new Date(currentMonth.getFullYear(), currentMonth.getMonth(), 1);
      const offset = (start.getDay() + 6) % 7;
      const dateIter = new Date(start);
      dateIter.setDate(start.getDate() - offset);

      for(let i=0; i<42; i++) {
        const d = new Date(dateIter);
        const iso = toISO(d);
        const count = allEvents.filter(e => e.date === iso).length;
        const isSelected = iso === toISO(selectedDate);
        
        const cell = document.createElement('div');
        cell.className = `day ${d.getMonth() !== currentMonth.getMonth() ? 'out' : ''} ${isSelected ? 'sel' : ''} ${iso === toISO(today) ? 'today' : ''}`;
        cell.innerHTML = `<div>${d.getDate()}</div>${count ? '<div class="badge"></div>' : ''}`;
        cell.onclick = () => { selectedDate = d; editingId = null; document.getElementById('shootForm').reset(); render(); };
        grid.appendChild(cell);
        dateIter.setDate(dateIter.getDate() + 1);
      }

      // –°–ø–∏—Å–æ–∫ –ø—Ä–æ–µ–∫—Ç–æ–≤ –¥–Ω—è
      const listDiv = document.getElementById('eventList');
      const dayEvents = allEvents.filter(e => e.date === toISO(selectedDate));
      listDiv.innerHTML = dayEvents.length ? '' : '<div style="padding:16px; opacity:0.5;">–°–º–µ–Ω –≤ —ç—Ç–æ—Ç –¥–µ–Ω—å –Ω–µ—Ç</div>';
      
      dayEvents.forEach(ev => {
        const item = document.createElement('div');
        item.className = 'item';
        item.innerHTML = `<b>${ev.project}</b><br><small>${ev.callTime || '--:--'} ‚Ä¢ ${ev.location || '–ë–µ–∑ –ª–æ–∫–∞—Ü–∏–∏'}</small>`;
        item.onclick = () => {
          editingId = ev.id;
          document.getElementById('project').value = ev.project || "";
          document.getElementById('location').value = ev.location || "";
          document.getElementById('callTime').value = ev.callTime || "";
          document.getElementById('wrapTime').value = ev.wrapTime || "";
          document.getElementById('address').value = ev.address || "";
          document.getElementById('contact').value = ev.contact || "";
          document.getElementById('deliverables').value = ev.deliverables || "";
          document.getElementById('crew').value = ev.crew || "";
          document.getElementById('schedule').value = ev.schedule || "";
          document.getElementById('gear').value = ev.gear || "";
          document.getElementById('notes').value = ev.notes || "";
          document.getElementById('delBtn').style.display = 'block';
        };
        listDiv.appendChild(item);
      });

      document.getElementById('preview').textContent = buildExportText();
    }

    // –ù–ê–í–ò–ì–ê–¶–ò–Ø
    function moveMonth(dir) { currentMonth.setMonth(currentMonth.getMonth() + dir); render(); }
    function goToday() { selectedDate = new Date(); currentMonth = new Date(selectedDate.getFullYear(), selectedDate.getMonth(), 1); render(); }
    function clearForm() { editingId = null; document.getElementById('shootForm').reset(); document.getElementById('delBtn').style.display = 'none'; }
    
    // –í–´–ì–†–£–ó–ö–ê
    async function copyToClipboard() {
      await navigator.clipboard.writeText(buildExportText());
      tg.HapticFeedback.impactOccurred('medium');
      alert("–¢–µ–∫—Å—Ç —Å–∫–æ–ø–∏—Ä–æ–≤–∞–Ω! üëç");
    }
    function downloadText() { 
      const blob = new Blob([buildExportText()], {type: "text/plain"});
      const a = document.createElement("a");
      a.href = URL.createObjectURL(blob); a.download = `shoot_${toISO(selectedDate)}.txt`; a.click();
    }

    loadData();
  </script>
</body>
</html>
