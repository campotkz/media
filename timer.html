<!DOCTYPE html>
<html lang="ru">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Film Timer PRO - Professional Clapperboard</title>
    <script src="https://telegram.org/js/telegram-web-app.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <link
        href="https://fonts.googleapis.com/css2?family=Orbitron:wght@400;700&family=Inter:wght@300;400;600;700&display=swap"
        rel="stylesheet">
    <style>
        :root {
            --bg-deep: #0e0e11;
            --bg-card: rgba(26, 26, 30, 0.85);
            --accent-red: #ff3b30;
            --accent-green: #34c759;
            --accent-blue: #007aff;
            --accent-yellow: #ffcc00;
            --accent-orange: #ff9500;
            --text-main: #ffffff;
            --text-dim: rgba(255, 255, 255, 0.5);
            --glass: rgba(255, 255, 255, 0.04);
            --border: rgba(255, 255, 255, 0.08);
            --safe-top: env(safe-area-inset-top);
        }

        * {
            box-sizing: border-box;
            -webkit-tap-highlight-color: transparent;
            outline: none;
        }

        body {
            margin: 0;
            padding: 0;
            background-color: var(--bg-deep);
            color: var(--text-main);
            font-family: 'Inter', sans-serif;
            height: 100vh;
            width: 100vw;
            overflow: hidden;
        }

        .viewport {
            display: flex;
            flex-direction: column;
            height: 100vh;
            width: 100%;
            padding: calc(var(--safe-top) + 8px) 12px 0;
        }

        /* HEADER */
        .header {
            display: flex;
            flex-direction: column;
            align-items: center;
            margin-bottom: 8px;
            flex-shrink: 0;
        }

        .main-timer {
            font-family: 'Orbitron', sans-serif;
            font-size: 32px;
            font-weight: 700;
            color: var(--accent-red);
            margin: 2px 0;
            text-shadow: 0 0 10px rgba(255, 59, 48, 0.3);
        }

        .project-tag {
            font-size: 10px;
            text-transform: uppercase;
            letter-spacing: 1.5px;
            color: var(--text-dim);
        }

        .location-tag {
            font-size: 13px;
            font-weight: 700;
            color: var(--accent-blue);
            margin-top: 2px;
            display: flex;
            align-items: center;
            gap: 5px;
            cursor: pointer;
        }

        /* STATUS BAR */
        .status-bar {
            background: var(--glass);
            border: 1px solid var(--border);
            border-radius: 12px;
            padding: 8px 12px;
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 10px;
            flex-shrink: 0;
        }

        .status-info {
            display: flex;
            align-items: center;
            gap: 8px;
            font-size: 12px;
            font-weight: 600;
        }

        .dot {
            width: 6px;
            height: 6px;
            border-radius: 50%;
            background: var(--text-dim);
        }

        .dot.active {
            background: var(--accent-green);
            box-shadow: 0 0 6px var(--accent-green);
            animation: pulse 1.5s infinite;
        }

        @keyframes pulse {
            0% {
                opacity: 1;
            }

            50% {
                opacity: 0.4;
            }

            100% {
                opacity: 1;
            }
        }

        .phase-timer {
            font-family: 'Orbitron', sans-serif;
            font-size: 12px;
            color: var(--accent-yellow);
        }

        /* SCROLLABLE CONTROL AREA */
        .controls {
            flex: 1;
            overflow-y: auto;
            padding-bottom: 100px;
            /* Space for footer and floating motor */
            -webkit-overflow-scrolling: touch;
            min-height: 0;
            /* Important for flex shrink */
        }

        .controls::-webkit-scrollbar {
            width: 4px;
        }

        .controls::-webkit-scrollbar-thumb {
            background: var(--border);
            border-radius: 4px;
        }

        .section {
            margin-bottom: 20px;
        }

        .section-header {
            font-size: 10px;
            font-weight: 800;
            color: var(--text-dim);
            text-transform: uppercase;
            letter-spacing: 1px;
            margin-bottom: 10px;
            padding-bottom: 4px;
            border-bottom: 1px solid var(--border);
        }

        .grid {
            display: grid;
            grid-template-columns: repeat(2, 1fr);
            gap: 10px;
        }

        .btn {
            background: var(--bg-card);
            border: 1px solid var(--border);
            border-radius: 14px;
            padding: 16px 10px;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            text-align: center;
            transition: all 0.1s;
        }

        .btn:active {
            transform: scale(0.95);
            background: rgba(255, 255, 255, 0.1);
        }

        .btn-label {
            font-size: 9px;
            text-transform: uppercase;
            font-weight: 700;
            color: var(--text-dim);
            margin-bottom: 4px;
        }

        .btn-val {
            font-size: 12px;
            font-weight: 700;
        }

        .btn.active {
            border-color: var(--color);
            background: var(--fade);
        }

        .btn.active .btn-label {
            color: var(--color);
        }

        .btn-motor-main {
            grid-column: span 2;
            padding: 24px;
            border-width: 2px;
            border-color: var(--accent-red);
            background: rgba(255, 59, 48, 0.1);
        }

        .btn-motor-main.active {
            background: rgba(255, 59, 48, 0.25);
            box-shadow: 0 0 15px rgba(255, 59, 48, 0.2);
        }

        .btn-motor-main .btn-val {
            font-size: 22px;
            font-weight: 900;
            letter-spacing: 2px;
        }

        /* COLORS */
        .c-red {
            --color: var(--accent-red);
            --fade: rgba(255, 59, 48, 0.15);
        }

        .c-green {
            --color: var(--accent-green);
            --fade: rgba(52, 199, 89, 0.15);
        }

        .c-blue {
            --color: var(--accent-blue);
            --fade: rgba(0, 122, 255, 0.15);
        }

        .c-yellow {
            --color: var(--accent-yellow);
            --fade: rgba(255, 204, 0, 0.15);
        }

        .c-orange {
            --color: var(--accent-orange);
            --fade: rgba(255, 149, 0, 0.15);
        }

        /* FOOTER STATS */
        .footer {
            background: #16161a;
            border-top: 1px solid var(--border);
            padding: 12px 14px;
            display: grid;
            grid-template-columns: 1fr 1fr 1fr;
            gap: 10px;
            flex-shrink: 0;
            z-index: 100;
        }

        .stat {
            text-align: center;
            cursor: pointer;
        }

        .stat-label {
            font-size: 8px;
            text-transform: uppercase;
            color: var(--text-dim);
            font-weight: 700;
        }

        .stat-val {
            font-size: 16px;
            font-weight: 800;
            margin-top: 2px;
        }

        /* OVERLAY / MODALS */
        .overlay {
            position: fixed;
            inset: 0;
            background: var(--bg-deep);
            z-index: 5000;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            padding: 40px;
            text-align: center;
        }

        .start-ring {
            width: 170px;
            height: 170px;
            border-radius: 50%;
            background: linear-gradient(135deg, #ff3b30, #ff2d55);
            box-shadow: 0 0 40px rgba(255, 59, 48, 0.4);
            border: none;
            color: white;
            font-weight: 900;
            font-size: 18px;
            margin-top: 30px;
            cursor: pointer;
        }

        .modal {
            position: fixed;
            inset: 0;
            background: rgba(0, 0, 0, 0.9);
            backdrop-filter: blur(10px);
            z-index: 6000;
            display: none;
            align-items: center;
            justify-content: center;
            padding: 20px;
        }

        .modal-box {
            background: #1c1c1e;
            border-radius: 24px;
            width: 100%;
            max-width: 340px;
            padding: 24px;
            border: 1px solid var(--border);
            box-shadow: 0 20px 40px rgba(0, 0, 0, 0.5);
        }

        .m-title {
            font-size: 18px;
            font-weight: 700;
            margin-bottom: 8px;
            text-align: center;
        }

        .m-desc {
            font-size: 14px;
            color: var(--text-dim);
            margin-bottom: 24px;
            text-align: center;
            line-height: 1.4;
        }

        .opt-list {
            display: flex;
            flex-direction: column;
            gap: 10px;
            max-height: 300px;
            overflow-y: auto;
        }

        .opt-item {
            background: var(--glass);
            padding: 15px;
            border-radius: 14px;
            text-align: center;
            border: 1px solid var(--border);
            font-weight: 600;
            transition: 0.1s;
        }

        .opt-item:active {
            background: rgba(255, 255, 255, 0.1);
            border-color: var(--accent-blue);
            transform: scale(0.98);
        }

        .m-btn {
            padding: 16px;
            border-radius: 14px;
            border: none;
            font-weight: 700;
            cursor: pointer;
            font-size: 14px;
            width: 100%;
        }

        .m-confirm {
            background: var(--accent-red);
            color: white;
            margin-top: 10px;
        }

        .m-cancel {
            background: transparent;
            color: var(--text-dim);
            margin-top: 5px;
        }

        .hidden {
            display: none !important;
        }

        /* MOBILE OPTIMIZATIONS */
        @media (max-width: 360px) {
            .main-timer {
                font-size: 28px;
            }

            .btn {
                padding: 12px 8px;
            }

            .btn-val {
                font-size: 11px;
            }
        }
    </style>
</head>

<body>
    <div class="viewport">
        <!-- START OVERLAY -->
        <div id="startOverlay" class="overlay">
            <span class="project-tag">FILM TIMER PRO</span>
            <h1 style="margin: 10px 0 0; font-size: 26px; font-weight: 800;">–°–ú–ï–ù–ê –ù–ï –ù–ê–ß–ê–¢–ê</h1>
            <p
                style="font-size: 15px; color: var(--text-dim); margin: 12px 0 30px; max-width: 260px; line-height: 1.5;">
                –ù–∞–∂–º–∏—Ç–µ –∫–Ω–æ–ø–∫—É —Å—Ç–∞—Ä—Ç–∞, –∫–æ–≥–¥–∞ –∫–æ–º–∞–Ω–¥–∞ –±—É–¥–µ—Ç –≥–æ—Ç–æ–≤–∞ –∫ —Ä–∞–±–æ—Ç–µ.</p>
            <button id="btnMainStart" class="start-ring">–ù–ê–ß–ê–¢–¨ –°–ú–ï–ù–£</button>
        </div>

        <!-- HEADER -->
        <div class="header">
            <span class="project-tag" id="elProjName">PROJECT_NAME</span>
            <div id="elShiftTimer" class="main-timer">00:00:00</div>
            <div id="elLocation" class="location-tag">üìç <span id="valLocation">–õ–û–ö–ê–¶–ò–Ø: –ö–í–ê–†–¢–ò–†–ê</span> ‚öôÔ∏è</div>
        </div>

        <!-- STATUS -->
        <div class="status-bar">
            <div class="status-info">
                <div id="elStatusDot" class="dot active"></div>
                <span id="elPhaseLabel">–û–ñ–ò–î–ê–ù–ò–ï</span>
            </div>
            <div id="elPhaseTimer" class="phase-timer">00:00</div>
        </div>

        <!-- CONTROLS -->
        <div id="controls" class="controls">
            <!-- 1. –ì–õ–û–ë–ê–õ–¨–ù–´–ï -->
            <div class="section">
                <div class="section-header">–ì–õ–û–ë–ê–õ–¨–ù–´–ï / –¢–ê–ô–ú–ò–ù–ì</div>
                <div class="grid">
                    <div class="btn" onclick="logEvent('travel_to_loc')"><span class="btn-label">–ü–µ—Ä–µ–µ–∑–¥</span><span
                            class="btn-val">TRAVEL TO LOC</span></div>
                    <div class="btn" onclick="logEvent('on_site')"><span class="btn-label">–ù–∞ –º–µ—Å—Ç–µ</span><span
                            class="btn-val">ON SITE</span></div>
                    <div class="btn c-red" onclick="logEvent('wrap')"><span class="btn-label">–°—Ç–æ–ø –∫–∞–º–µ—Ä–∞</span><span
                            class="btn-val">WRAP (STOP CAM)</span></div>
                    <div class="btn c-red" onclick="logEvent('last_man_out')"><span class="btn-label">–°–¥–∞—á–∞
                            –ø–ª–æ—â–∞–¥–∫–∏</span><span class="btn-val">LAST MAN OUT</span></div>
                </div>
            </div>

            <!-- 2. –ü–†–ò–ë–´–¢–ò–ï -->
            <div class="section">
                <div class="section-header">–ü–†–ò–ë–´–¢–ò–ï (CHECK-IN)</div>
                <div class="grid">
                    <div class="btn" onclick="logEvent('crew_arrival')"><span class="btn-label">–ì—Ä—É–ø–ø–∞</span><span
                            class="btn-val">CREW ARRIVAL</span></div>
                    <div class="btn" onclick="logEvent('client_arrival')"><span class="btn-label">–ó–∞–∫–∞–∑—á–∏–∫</span><span
                            class="btn-val">CLIENT / AGENCY</span></div>
                    <div class="btn" style="grid-column: span 2" onclick="showOptionModal('actor_checkin')"><span
                            class="btn-label">–ê–∫—Ç–µ—Ä—ã</span><span class="btn-val">ACTOR CHECK-IN</span></div>
                </div>
            </div>

            <!-- 3. –ü–û–î–ì–û–¢–û–í–ö–ê –ê–ö–¢–ï–†–û–í -->
            <div class="section">
                <div class="section-header">–ü–û–î–ì–û–¢–û–í–ö–ê –ê–ö–¢–ï–†–û–í</div>
                <div class="grid">
                    <div class="btn c-blue" data-toggle="makeup"><span class="btn-label">–ù–∞—á–∞–ª–æ/–ö–æ–Ω–µ—Ü</span><span
                            class="btn-val">–ì–†–ò–ú</span></div>
                    <div class="btn c-blue" data-toggle="wardrobe"><span class="btn-label">–ù–∞—á–∞–ª–æ/–ö–æ–Ω–µ—Ü</span><span
                            class="btn-val">–ö–û–°–¢–Æ–ú</span></div>
                    <div class="btn c-blue" data-toggle="sound_rigging"><span class="btn-label">–£—Å—Ç–∞–Ω–æ–≤–∫–∞</span><span
                            class="btn-val">–û–ü–ï–¢–õ–ò–ß–ò–í–ê–ù–ò–ï</span></div>
                    <div class="btn c-green" onclick="logEvent('actor_ready')"><span class="btn-label">–§–∏–Ω–∞–ª—å–Ω—ã–π
                            —Å—Ç–∞—Ç—É—Å</span><span class="btn-val">–ê–ö–¢–ï–† –ì–û–¢–û–í</span></div>
                </div>
            </div>

            <!-- 4. –¢–ï–•–ù–ò–ß–ï–°–ö–ê–Ø –ü–û–î–ì–û–¢–û–í–ö–ê -->
            <div class="section">
                <div class="section-header">–¢–ï–•–ù–ò–ß–ï–°–ö–ê–Ø –ü–û–î–ì–û–¢–û–í–ö–ê</div>
                <div class="grid">
                    <div class="btn c-yellow" onclick="setPhase('LIGHT_SET', '–í–´–°–¢–ê–í–õ–ï–ù–ò–ï –°–í–ï–¢–ê')"><span
                            class="btn-label">–ü–µ—Ä–≤–∏—á–Ω—ã–π</span><span class="btn-val">–í–´–°–¢. –°–í–ï–¢–ê</span></div>
                    <div class="btn c-yellow" onclick="setPhase('LIGHT_ADJ', '–ü–ï–†–ï–°–¢–ê–ù–û–í–ö–ê –°–í–ï–¢–ê')"><span
                            class="btn-label">–ü—Ä–∞–≤–∫–∏</span><span class="btn-val">–ü–ï–†–ï–°–¢. –°–í–ï–¢–ê</span></div>
                    <div class="btn c-yellow" onclick="setPhase('CAM_PREP', '–ö–ê–ú–ï–†–ê –ü–†–ï–î')"><span class="btn-label">–ö—Ä–∞–Ω
                            / –û–ø—Ç–∏–∫–∞</span><span class="btn-val">–ö–ê–ú–ï–†–ê –ü–†–ï–î</span></div>
                    <div class="btn c-yellow" onclick="setPhase('ART_DEPT', '–•–£–î–û–ñ–ù–ò–ö–ò')"><span
                            class="btn-label">–†–µ–∫–≤–∏–∑–∏—Ç</span><span class="btn-val">–•–£–î–û–ñ–ù–ò–ö–ò</span></div>
                    <div class="btn c-orange" style="grid-column: span 2" onclick="setPhase('SFX', '–°–§–ï–ö–° / –î–´–ú')"><span
                            class="btn-label">–°–ø–µ—Ü—ç—Ñ—Ñ–µ–∫—Ç—ã</span><span class="btn-val">–°–§–ï–ö–° / –î–´–ú –ü–†–ï–î</span></div>
                </div>
            </div>

            <!-- 5. –†–ï–ü–ï–¢–ò–¶–ò–ò –ò –°–™–ï–ú–ö–ê -->
            <div class="section" id="sectionAction">
                <div class="section-header">–†–ï–ü–ï–¢–ò–¶–ò–ò –ò –°–™–ï–ú–ö–ê</div>
                <div class="grid">
                    <div id="btnMotor" class="btn btn-motor-main c-red"><span class="btn-label">–ó–∞–ø–∏—Å—å</span><span
                            id="motorTitle" class="btn-val">–ú–û–¢–û–†</span></div>
                    <div class="btn c-green" onclick="setPhase('BLOCKING', '–ë–õ–û–ö–ò–†–û–í–ö–ê')"><span
                            class="btn-label">–ú–∏–∑–∞–Ω—Å—Ü–µ–Ω–∞</span><span class="btn-val">–ë–õ–û–ö–ò–†–û–í–ö–ê</span></div>
                    <div class="btn c-green" onclick="setPhase('REHEARSAL', '–†–ï–ü–ï–¢–ò–¶–ò–Ø')"><span class="btn-label">–ë–µ–∑
                            –∫–∞–º–µ—Ä—ã</span><span class="btn-val">–†–ï–ü–ï–¢–ò–¶–ò–Ø</span></div>
                    <div class="btn c-green" onclick="setPhase('DRESS_REH', '–ì–ï–ù. –†–ï–ü–ï–¢–ò–¶–ò–Ø')"><span class="btn-label">–í
                            –∫–æ—Å—Ç—é–º–∞—Ö</span><span class="btn-val">–ì–ï–ù. –†–ï–ü–ï–¢–ò–¶–ò–Ø</span></div>
                    <div class="btn c-orange" onclick="logEvent('series_start')"><span class="btn-label">–ú–Ω–æ–≥–æ
                            –¥—É–±–ª–µ–π</span><span class="btn-val">–°–ï–†–ò–Ø</span></div>
                    <div class="btn" onclick="showOptionModal('next_scene')"><span
                            class="btn-label">–°—Ü–µ–Ω–∞—Ä–∏—è</span><span class="btn-val">–°–õ–ï–î. –°–¶–ï–ù–ê</span></div>
                </div>
            </div>

            <!-- 6. –õ–û–ì–ò–°–¢–ò–ö–ê -->
            <div class="section">
                <div class="section-header">–õ–û–ì–ò–°–¢–ò–ö–ê –ò –ü–ï–†–ï–†–´–í–´</div>
                <div class="grid">
                    <div id="btnLunch" class="btn c-blue"><span class="btn-label">60 –º–∏–Ω—É—Ç</span><span
                            class="btn-val">–û–ë–ï–î</span></div>
                    <div class="btn c-blue" onclick="logEvent('tech_break')"><span class="btn-label">15 –º–∏–Ω</span><span
                            class="btn-val">–¢–ï–•. –ü–ï–†–ï–†–´–í</span></div>
                    <div class="btn c-blue" onclick="showOptionModal('location_change')"><span class="btn-label">–°–º–µ–Ω–∞
                            –æ–±—ä–µ–∫—Ç–∞</span><span class="btn-val">–ü–ï–†–ï–ï–ó–î</span></div>
                    <div class="btn c-blue" onclick="logEvent('catering_arrival')"><span
                            class="btn-label">–ì–æ—Ä—è—á–µ–µ</span><span class="btn-val">–ë–£–§–ï–¢ –ü–†–ò–ï–•–ê–õ</span></div>
                </div>
            </div>

            <!-- 7. –ó–ê–î–ï–†–ñ–ö–ò -->
            <div class="section">
                <div class="section-header">–ó–ê–î–ï–†–ñ–ö–ò (DELAYS)</div>
                <div class="grid">
                    <div class="btn c-orange" onclick="showDelayModal('tech')"><span
                            class="btn-label">–ü—Ä–æ–±–ª–µ–º–∞</span><span class="btn-val">TECH</span></div>
                    <div class="btn c-orange" onclick="showDelayModal('crew')"><span
                            class="btn-label">–ü—Ä–æ–±–ª–µ–º–∞</span><span class="btn-val">CREW</span></div>
                    <div class="btn c-orange" onclick="showDelayModal('actor')"><span
                            class="btn-label">–ü—Ä–æ–±–ª–µ–º–∞</span><span class="btn-val">ACTOR</span></div>
                    <div class="btn c-orange" onclick="showDelayModal('client')"><span
                            class="btn-label">–ü—Ä–æ–±–ª–µ–º–∞</span><span class="btn-val">CLIENT</span></div>
                    <div class="btn c-orange" onclick="showDelayModal('weather')"><span
                            class="btn-label">–ü—Ä–æ–±–ª–µ–º–∞</span><span class="btn-val">WEATHER</span></div>
                    <div class="btn c-orange" onclick="showDelayModal('noise')"><span
                            class="btn-label">–ü—Ä–æ–±–ª–µ–º–∞</span><span class="btn-val">NOISE</span></div>
                </div>
            </div>

            <!-- 8. –î–û–ü–û–õ–ù–ò–¢–ï–õ–¨–ù–û -->
            <div class="section">
                <div class="section-header">–î–û–ü–û–õ–ù–ò–¢–ï–õ–¨–ù–û</div>
                <div class="grid">
                    <div class="btn" onclick="logEvent('dit_start')"><span class="btn-label">DIT</span><span
                            class="btn-val">BACKUP</span></div>
                    <div class="btn" onclick="logEvent('bts_photo')"><span class="btn-label">BTS</span><span
                            class="btn-val">PHOTO / BTS</span></div>
                    <div class="btn" onclick="logEvent('police')"><span class="btn-label">–ü—Ä–æ–≤–µ—Ä–∫–∞</span><span
                            class="btn-val">POLICE</span></div>
                    <div class="btn c-blue" onclick="showOptionModal('note')"><span
                            class="btn-label">–ó–∞–º–µ—Ç–∫–∞</span><span class="btn-val">MEMO</span></div>
                </div>
            </div>
        </div>

        <!-- FOOTER -->
        <div class="footer">
            <div class="stat" onclick="showOptionModal('next_scene')">
                <div class="stat-label">–°–¶–ï–ù–ê</div>
                <div id="valScene" class="stat-val">1</div>
            </div>
            <div class="stat" id="elTakeBtn">
                <div class="stat-label">–î–£–ë–õ–¨</div>
                <div id="valTake" class="stat-val">0</div>
            </div>
            <div class="stat" style="color: var(--accent-red)" id="btnFinalWrap">
                <div class="stat-label">STOP</div>
                <div id="btnFinalWrapVal" class="stat-val">–°–ú–ï–ù–ê</div>
            </div>
        </div>
    </div>

    <!-- MODAL -->
    <div id="modal" class="modal">
        <div id="modalBox" class="modal-box">
            <h3 id="modalTitle" class="m-title">Title</h3>
            <p id="modalDesc" class="m-desc">Description</p>
            <div id="modalOptions" class="opt-list hidden"></div>
            <div id="modalButtons" class="m-grid">
                <button id="btnModalConfirm" class="m-btn m-confirm">–ü–û–î–¢–í–ï–†–î–ò–¢–¨</button>
                <button id="btnModalCancel" class="m-btn m-cancel">–û–¢–ú–ï–ù–ê</button>
            </div>
        </div>
    </div>

    <script>
        const tg = window.Telegram.WebApp;
        tg.expand();
        tg.enableClosingConfirmation();

        const SUPABASE_URL = "https://waekzofajzqcpoeldhkt.supabase.co";
        const SUPABASE_KEY = "sb_publishable_XVByRUkaKbM-11ChwOd2Aw_y24CSb4V";
        const sb = supabase.createClient(SUPABASE_URL, SUPABASE_KEY);

        let state = {
            shiftId: localStorage.getItem('shift_id'),
            startTime: localStorage.getItem('start_time'),
            status: localStorage.getItem('status') || 'inactive',
            phase: localStorage.getItem('phase') || 'IDLE',
            phaseStartTime: localStorage.getItem('phase_start') || null,
            location: localStorage.getItem('location') || '–ö–í–ê–†–¢–ò–†–ê',
            scene: parseInt(localStorage.getItem('scene')) || 1,
            take: parseInt(localStorage.getItem('take')) || 0,
            isMotor: false,
            lunch: false,
            project: { id: null, name: '...' }
        };

        const ui = {
            overlay: document.getElementById('startOverlay'),
            shiftTimer: document.getElementById('elShiftTimer'),
            phaseTimer: document.getElementById('elPhaseTimer'),
            phaseLabel: document.getElementById('elPhaseLabel'),
            locationLabel: document.getElementById('valLocation'),
            sceneLabel: document.getElementById('valScene'),
            takeLabel: document.getElementById('valTake'),
            motorBtn: document.getElementById('btnMotor'),
            motorTitle: document.getElementById('motorTitle'),
            modal: document.getElementById('modal'),
            modalTitle: document.getElementById('modalTitle'),
            modalDesc: document.getElementById('modalDesc'),
            modalOptions: document.getElementById('modalOptions'),
            modalButtons: document.getElementById('modalButtons'),
            controls: document.getElementById('controls')
        };

        function initApp() {
            const params = new URLSearchParams(window.location.search);
            state.project = {
                id: params.get('pid'),
                name: params.get('proj') || '–ü—Ä–æ–µ–∫—Ç',
                cid: params.get('cid'),
                tid: params.get('tid')
            };
            document.getElementById('elProjName').textContent = state.project.name;
            ui.locationLabel.textContent = `–õ–û–ö–ê–¶–ò–Ø: ${state.location}`;
            ui.sceneLabel.textContent = state.scene;
            ui.takeLabel.textContent = state.take;
            ui.phaseLabel.textContent = state.phase === 'IDLE' ? '–û–ñ–ò–î–ê–ù–ò–ï' : (localStorage.getItem('phase_label') || state.phase);

            if (state.status === 'active') {
                ui.overlay.classList.add('hidden');
                document.body.style.overflow = 'hidden';
            }
        }

        function saveState() {
            localStorage.setItem('shift_id', state.shiftId || '');
            localStorage.setItem('start_time', state.startTime || '');
            localStorage.setItem('status', state.status);
            localStorage.setItem('location', state.location);
            localStorage.setItem('scene', state.scene);
            localStorage.setItem('take', state.take);
            localStorage.setItem('phase', state.phase);
            localStorage.setItem('phase_start', state.phaseStartTime || '');
            localStorage.setItem('phase_label', ui.phaseLabel.textContent);
        }

        async function logEvent(type, data = {}) {
            if (!state.shiftId) {
                console.warn("Attempted log without shiftId:", type);
                return;
            }
            try {
                const entry = {
                    shift_id: state.shiftId,
                    event_type: type,
                    data: { ...data, scene_no: state.scene, take_no: state.take, loc: state.location }
                };
                // Fire and forget but keep a log
                sb.from('production_logs').insert(entry).then(({ error }) => {
                    if (error) console.error("Log error return:", error);
                });
                tg.HapticFeedback.impactOccurred('light');
            } catch (e) { console.error("Log exception:", e); }
        }

        setInterval(() => {
            if (state.startTime) {
                const diff = new Date() - new Date(state.startTime);
                ui.shiftTimer.textContent = formatTime(diff);
            }
            if (state.phaseStartTime) {
                const diff = new Date() - new Date(state.phaseStartTime);
                ui.phaseTimer.textContent = formatTimeShort(diff);
            }
        }, 1000);

        function formatTime(ms) {
            const h = Math.floor(ms / 3600000);
            const m = Math.floor((ms % 3600000) / 60000);
            const s = Math.floor((ms % 60000) / 1000);
            return `${h.toString().padStart(2, '0')}:${m.toString().padStart(2, '0')}:${s.toString().padStart(2, '0')}`;
        }
        function formatTimeShort(ms) {
            const m = Math.floor(ms / 60000);
            const s = Math.floor((ms % 60000) / 1000);
            return `${m.toString().padStart(2, '0')}:${s.toString().padStart(2, '0')}`;
        }

        // START SHIFT (Triple Check)
        let startStep = 0;
        const startChecks = [
            { t: "–ö–æ–º–∞–Ω–¥–∞ –Ω–∞ –º–µ—Å—Ç–µ?", d: "–í—Å–µ —Ü–µ—Ö–∞ –ø—Ä–∏–±—ã–ª–∏ –∏ –≥–æ—Ç–æ–≤—ã –∫ —Ä–∞–±–æ—Ç–µ?" },
            { t: "–¢–∞–π–º–∏–Ω–≥ –≤–µ—Ä–Ω—ã–π?", d: "–¢–µ–∫—É—â–µ–µ –≤—Ä–µ–º—è —Å–æ–æ—Ç–≤–µ—Ç—Å—Ç–≤—É–µ—Ç –≤—ã–∑—ã–≤–Ω–æ–º—É?" },
            { t: "–ü–û–î–¢–í–ï–†–î–ò–¢–¨ –°–¢–ê–†–¢?", d: "–≠—Ç–æ –æ—Ñ–∏—Ü–∏–∞–ª—å–Ω–æ –∑–∞–ø—É—Å—Ç–∏—Ç —Ä–∞–±–æ—á—É—é —Å–º–µ–Ω—É." }
        ];

        document.getElementById('btnMainStart').onclick = () => {
            startStep = 0;
            showConfirm(startChecks[0].t, startChecks[0].d, () => nextStartStep());
        };

        function nextStartStep() {
            startStep++;
            if (startStep < startChecks.length) {
                showConfirm(startChecks[startStep].t, startChecks[startStep].d, () => nextStartStep());
            } else {
                doStart();
            }
        }

        async function doStart() {
            try {
                const now = new Date().toISOString();
                const { data, error } = await sb.from('production_shifts').insert({
                    project_id: state.project.id, chat_id: state.project.cid, thread_id: state.project.tid, start_time: now, status: 'active'
                }).select();

                if (error) { alert("–û—à–∏–±–∫–∞ –∑–∞–ø—É—Å–∫–∞ (DB): " + error.message); return; }

                if (data && data[0]) {
                    state.shiftId = data[0].id;
                    state.startTime = now;
                    state.status = 'active';
                    state.phase = 'SHIFT_START';
                    state.phaseStartTime = now;
                    ui.phaseLabel.textContent = '–°–¢–ê–†–¢ –°–ú–ï–ù–´';
                    saveState();
                    ui.overlay.classList.add('hidden');
                    logEvent('shift_start');
                    tg.HapticFeedback.notificationOccurred('success');
                }
            } catch (err) { alert("–û—à–∏–±–∫–∞ –∑–∞–ø—É—Å–∫–∞ (JS): " + err.message); }
        }

        function setPhase(code, label) {
            state.phase = code;
            state.phaseStartTime = new Date().toISOString();
            ui.phaseLabel.textContent = label;
            saveState();
            logEvent(code.toLowerCase());
            tg.HapticFeedback.impactOccurred('medium');

            // Visual feedback on buttons
            document.querySelectorAll('.btn').forEach(b => b.classList.remove('active'));
            // Note: button highlighting is tricky with dynamic text, maybe add IDs later
        }

        ui.motorBtn.onclick = () => {
            state.isMotor = !state.isMotor;
            if (state.isMotor) {
                state.take++; ui.takeLabel.textContent = state.take; saveState();
                ui.motorBtn.classList.add('active'); ui.motorTitle.textContent = '–°–¢–û–ü';
                setPhase('MOTOR', '–°–™–ï–ú–ö–ê'); tg.HapticFeedback.impactOccurred('heavy');
            } else {
                ui.motorBtn.classList.remove('active'); ui.motorTitle.textContent = '–ú–û–¢–û–†';
                setPhase('CUT', '–ü–ê–£–ó–ê'); showEvaluation();
            }
        };

        document.getElementById('elTakeBtn').onclick = () => {
            state.take++; ui.takeLabel.textContent = state.take; saveState(); logEvent('take_increment');
        };

        function showEvaluation() {
            showOptions("–û—Ü–µ–Ω–∫–∞ –¥—É–±–ª—è", "–ö–∞–∫ –ø—Ä–æ—à–µ–ª –¥—É–±–ª—å?", [
                { l: "‚≠ê GOOD (–•–æ—Ä–æ—à–æ)", v: "good" },
                { l: "‚ùå BRAK (–ë—Ä–∞–∫)", v: "bad" },
                { l: "‚öôÔ∏è TECH (–¢–µ—Ö. –æ—à–∏–±–∫–∞)", v: "tech" }
            ], (val) => logEvent('take_evaluation', { result: val }));
        }

        document.getElementById('btnLunch').onclick = () => {
            state.lunch = !state.lunch;
            const b = document.getElementById('btnLunch');
            if (state.lunch) { b.classList.add('active'); logEvent('lunch_start'); }
            else { b.classList.remove('active'); logEvent('lunch_end'); }
        };

        document.getElementById('elLocation').onclick = () => {
            const loc = prompt("–ù–æ–≤–∞—è –ª–æ–∫–∞—Ü–∏—è (–û–±—ä–µ–∫—Ç):", state.location);
            if (loc) {
                state.location = loc;
                ui.locationLabel.textContent = `–õ–û–ö–ê–¶–ò–Ø: ${loc}`;
                saveState(); logEvent('location_change', { new_loc: loc });
            }
        };

        function showDelayModal(category) {
            const reason = prompt(`–ü—Ä–∏—á–∏–Ω–∞ –∑–∞–¥–µ—Ä–∂–∫–∏ (${category.toUpperCase()}):`, "");
            if (reason) logEvent(`delay_${category}`, { reason });
        }

        function showOptionModal(type) {
            if (type === 'next_scene') {
                const next = prompt("–ù–æ–º–µ—Ä –Ω–æ–≤–æ–π —Å—Ü–µ–Ω—ã:", state.scene + 1);
                if (next) {
                    state.scene = parseInt(next);
                    state.take = 0;
                    ui.sceneLabel.textContent = state.scene;
                    ui.takeLabel.textContent = 0;
                    saveState(); logEvent('next_scene');
                }
            } else if (type === 'actor_checkin') {
                const name = prompt("–ò–º—è –∞–∫—Ç–µ—Ä–∞:");
                if (name) logEvent('actor_arrival', { name });
            } else if (type === 'note') {
                const txt = prompt("–ó–∞–º–µ—Ç–∫–∞ / –ö–æ–º–º–µ–Ω—Ç–∞—Ä–∏–π:");
                if (txt) logEvent('note', { text: txt });
            } else if (type === 'location_change') {
                document.getElementById('elLocation').click();
            }
        }

        document.getElementById('btnFinalWrap').onclick = () => {
            showConfirm("–ó–ê–í–ï–†–®–ò–¢–¨ –°–ú–ï–ù–£?", "–≠—Ç–æ –æ—Å—Ç–∞–Ω–æ–≤–∏—Ç —Ç–∞–π–º–µ—Ä –∏ –æ—Ç–ø—Ä–∞–≤–∏—Ç –æ—Ç—á–µ—Ç –≤ —á–∞—Ç.", () => finishShift());
        };

        async function finishShift() {
            try {
                document.getElementById('btnFinalWrapVal').textContent = '...';
                const end = new Date().toISOString();

                // Fire and forget report
                fetch('/api/timer/report', {
                    method: 'POST', headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ shift_id: state.shiftId, chat_id: state.project.cid, thread_id: state.project.tid })
                }).catch(e => console.error("Report trigger error", e));

                await sb.from('production_shifts').update({ status: 'finished', end_time: end }).eq('id', state.shiftId);
                await logEvent('shift_finish');

            } catch (err) { console.error("Finish error:", err); }
            finally {
                localStorage.clear();
                tg.close();
                // If it's not a TWA (opened as URL), just clear UI
                ui.overlay.classList.remove('hidden');
                state.status = 'inactive';
                state.shiftId = null;
                state.startTime = null;
            }
        }

        function showConfirm(title, desc, onOk) {
            ui.modalTitle.textContent = title; ui.modalDesc.textContent = desc;
            ui.modalOptions.classList.add('hidden'); ui.modalButtons.classList.remove('hidden');
            ui.modal.style.display = 'flex';
            document.getElementById('btnModalConfirm').onclick = () => { ui.modal.style.display = 'none'; onOk(); };
            document.getElementById('btnModalCancel').onclick = () => { ui.modal.style.display = 'none'; };
        }

        function showOptions(title, desc, options, onSelect) {
            ui.modalTitle.textContent = title; ui.modalDesc.textContent = desc;
            ui.modalOptions.innerHTML = ''; ui.modalOptions.classList.remove('hidden');
            ui.modalButtons.classList.add('hidden');
            options.forEach(o => {
                const div = document.createElement('div'); div.className = 'opt-item'; div.textContent = o.l;
                div.onclick = () => { ui.modal.style.display = 'none'; onSelect(o.v); };
                ui.modalOptions.appendChild(div);
            });
            ui.modal.style.display = 'flex';
        }

        // Toggle buttons (Makeup, Wardrobe, etc)
        document.querySelectorAll('[data-toggle]').forEach(b => {
            b.onclick = () => {
                const key = b.getAttribute('data-toggle');
                if (!b.classList.contains('active')) {
                    showOptions("–°–ö–û–õ–¨–ö–û –ú–ò–ù–£–¢?", `–ü–ª–∞–Ω –Ω–∞ ${key.toUpperCase()}:`, [
                        { l: "5 –ú–ò–ù", v: "5" }, { l: "15 –ú–ò–ù", v: "15" }, { l: "30 –ú–ò–ù", v: "30" }, { l: "–°–í–û–ô –í–ê–†–ò–ê–ù–¢", v: "custom" }
                    ], (val) => {
                        let mins = (val === 'custom') ? prompt("–ú–∏–Ω—É—Ç:", "20") : val;
                        if (mins) {
                            b.classList.add('active');
                            logEvent(`${key}_start`, { promised: mins });
                        }
                    });
                } else {
                    b.classList.remove('active');
                    logEvent(`${key}_end`);
                }
            };
        });

        initApp();
    </script>
</body>

</html>