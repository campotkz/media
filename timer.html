<!DOCTYPE html>
<html lang="ru">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Film Timer PRO - Professional Clapperboard</title>
    <script src="https://telegram.org/js/telegram-web-app.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <link
        href="https://fonts.googleapis.com/css2?family=Orbitron:wght@400;700&family=Inter:wght@300;400;600;700&display=swap"
        rel="stylesheet">
    <style>
        :root {
            --bg-deep: #0e0e11;
            --bg-card: rgba(26, 26, 30, 0.85);
            --accent-red: #ff3b30;
            --accent-green: #34c759;
            --accent-blue: #007aff;
            --accent-yellow: #ffcc00;
            --accent-orange: #ff9500;
            --text-main: #ffffff;
            --text-dim: rgba(255, 255, 255, 0.5);
            --glass: rgba(255, 255, 255, 0.04);
            --border: rgba(255, 255, 255, 0.08);
            --safe-top: env(safe-area-inset-top);
        }

        * {
            box-sizing: border-box;
            -webkit-tap-highlight-color: transparent;
            outline: none;
        }

        body {
            margin: 0;
            padding: 0;
            background-color: var(--bg-deep);
            color: var(--text-main);
            font-family: 'Inter', sans-serif;
            height: 100vh;
            width: 100vw;
            overflow: hidden;
        }

        .viewport {
            display: flex;
            flex-direction: column;
            height: 100vh;
            width: 100%;
            padding: calc(var(--safe-top) + 8px) 12px 0;
        }

        /* HEADER */
        .header {
            display: flex;
            flex-direction: column;
            align-items: center;
            margin-bottom: 8px;
            flex-shrink: 0;
        }

        .main-timer {
            font-family: 'Orbitron', sans-serif;
            font-size: 32px;
            font-weight: 700;
            color: var(--accent-red);
            margin: 2px 0;
            text-shadow: 0 0 10px rgba(255, 59, 48, 0.3);
        }

        .project-tag {
            font-size: 10px;
            text-transform: uppercase;
            letter-spacing: 1.5px;
            color: var(--text-dim);
        }

        .location-tag {
            font-size: 13px;
            font-weight: 700;
            color: var(--accent-blue);
            margin-top: 2px;
            display: flex;
            align-items: center;
            gap: 5px;
            cursor: pointer;
        }

        /* STATUS BAR */
        .status-bar {
            background: var(--glass);
            border: 1px solid var(--border);
            border-radius: 12px;
            padding: 8px 12px;
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 10px;
            flex-shrink: 0;
            transition: all 0.3s;
        }

        .status-info {
            display: flex;
            align-items: center;
            gap: 8px;
            font-size: 12px;
            font-weight: 600;
        }

        .dot {
            width: 6px;
            height: 6px;
            border-radius: 50%;
            background: var(--text-dim);
        }

        .dot.active {
            background: var(--accent-green);
            box-shadow: 0 0 6px var(--accent-green);
            animation: pulse 1.5s infinite;
        }

        @keyframes pulse {
            0% {
                opacity: 1;
            }

            50% {
                opacity: 0.4;
            }

            100% {
                opacity: 1;
            }
        }

        .phase-timer {
            font-family: 'Orbitron', sans-serif;
            font-size: 12px;
            color: var(--accent-yellow);
        }

        /* SCROLLABLE CONTROL AREA */
        .controls {
            flex: 1;
            overflow-y: auto;
            padding-bottom: 20px;
            -webkit-overflow-scrolling: touch;
            min-height: 0;
        }

        .controls::-webkit-scrollbar {
            width: 4px;
        }

        .controls::-webkit-scrollbar-thumb {
            background: var(--border);
            border-radius: 4px;
        }

        .section {
            margin-bottom: 20px;
        }

        .section-header {
            font-size: 10px;
            font-weight: 800;
            color: var(--text-dim);
            text-transform: uppercase;
            letter-spacing: 1px;
            margin-bottom: 10px;
            padding-bottom: 4px;
            border-bottom: 1px solid var(--border);
        }

        .grid {
            display: grid;
            grid-template-columns: repeat(2, 1fr);
            gap: 10px;
        }

        .btn {
            background: var(--bg-card);
            border: 1px solid var(--border);
            border-radius: 14px;
            padding: 16px 10px;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            text-align: center;
            transition: all 0.1s;
            position: relative;
        }

        .btn:active {
            transform: scale(0.95);
            background: rgba(255, 255, 255, 0.1);
        }

        .btn-label {
            font-size: 9px;
            text-transform: uppercase;
            font-weight: 700;
            color: var(--text-dim);
            margin-bottom: 4px;
        }

        .btn-val {
            font-size: 12px;
            font-weight: 700;
        }

        .btn-timer {
            font-family: 'Orbitron', sans-serif;
            font-size: 10px;
            color: var(--accent-yellow);
            margin-top: 4px;
            display: none;
        }

        .btn.active {
            border-color: var(--color);
            background: var(--fade);
            animation: borderPulse 2s infinite;
        }

        .btn.active .btn-timer {
            display: block;
        }

        @keyframes borderPulse {
            0% {
                border-color: var(--border);
            }

            50% {
                border-color: var(--color);
                box-shadow: 0 0 10px var(--fade);
            }

            100% {
                border-color: var(--border);
            }
        }

        .btn.active .btn-label {
            color: var(--color);
        }

        .btn-motor-main {
            grid-column: span 2;
            padding: 24px;
            border-width: 2px;
            border-color: var(--accent-red);
            background: rgba(255, 59, 48, 0.1);
        }

        .btn-motor-main.active {
            background: rgba(255, 59, 48, 0.25);
            border-color: var(--accent-red);
            animation: none;
        }

        .btn-motor-main .btn-val {
            font-size: 22px;
            font-weight: 900;
            letter-spacing: 2px;
        }

        /* COLORS */
        .c-red {
            --color: var(--accent-red);
            --fade: rgba(255, 59, 48, 0.15);
        }

        .c-green {
            --color: var(--accent-green);
            --fade: rgba(52, 199, 89, 0.15);
        }

        .c-blue {
            --color: var(--accent-blue);
            --fade: rgba(0, 122, 255, 0.15);
        }

        .c-yellow {
            --color: var(--accent-yellow);
            --fade: rgba(255, 204, 0, 0.15);
        }

        .c-orange {
            --color: var(--accent-orange);
            --fade: rgba(255, 149, 0, 0.15);
        }

        /* FOOTER STATS */
        .footer {
            background: #16161a;
            border-top: 1px solid var(--border);
            padding: 12px 14px;
            display: grid;
            grid-template-columns: 1fr 1fr 1fr 1fr;
            gap: 10px;
            flex-shrink: 0;
            z-index: 100;
        }

        .stat {
            text-align: center;
            cursor: pointer;
        }

        .stat-label {
            font-size: 8px;
            text-transform: uppercase;
            color: var(--text-dim);
            font-weight: 700;
        }

        .stat-val {
            font-size: 16px;
            font-weight: 800;
            margin-top: 2px;
        }

        /* OVERLAY / MODALS */
        .overlay {
            position: fixed;
            inset: 0;
            background: var(--bg-deep);
            z-index: 5000;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            padding: 40px;
            text-align: center;
        }

        .start-ring {
            width: 170px;
            height: 170px;
            border-radius: 50%;
            background: linear-gradient(135deg, #ff3b30, #ff2d55);
            box-shadow: 0 0 40px rgba(255, 59, 48, 0.4);
            border: none;
            color: white;
            font-weight: 900;
            font-size: 18px;
            margin-top: 30px;
            cursor: pointer;
        }

        .modal {
            position: fixed;
            inset: 0;
            background: rgba(0, 0, 0, 0.9);
            backdrop-filter: blur(10px);
            z-index: 6000;
            display: none;
            align-items: center;
            justify-content: center;
            padding: 20px;
        }

        .modal-box {
            background: #1c1c1e;
            border-radius: 24px;
            width: 100%;
            max-width: 340px;
            padding: 24px;
            border: 1px solid var(--border);
            box-shadow: 0 20px 40px rgba(0, 0, 0, 0.5);
        }

        .m-title {
            font-size: 18px;
            font-weight: 700;
            margin-bottom: 8px;
            text-align: center;
        }

        .m-desc {
            font-size: 14px;
            color: var(--text-dim);
            margin-bottom: 24px;
            text-align: center;
            line-height: 1.4;
        }

        .opt-list {
            display: flex;
            flex-direction: column;
            gap: 10px;
            max-height: 300px;
            overflow-y: auto;
        }

        .opt-item {
            background: var(--glass);
            padding: 15px;
            border-radius: 14px;
            text-align: center;
            border: 1px solid var(--border);
            font-weight: 600;
            transition: 0.1s;
        }

        .opt-item:active {
            background: rgba(255, 255, 255, 0.1);
            border-color: var(--accent-blue);
            transform: scale(0.98);
        }

        .m-btn {
            padding: 16px;
            border-radius: 14px;
            border: none;
            font-weight: 700;
            cursor: pointer;
            font-size: 14px;
            width: 100%;
        }

        .m-confirm {
            background: var(--accent-red);
            color: white;
            margin-top: 10px;
        }

        .m-cancel {
            background: transparent;
            color: var(--text-dim);
            margin-top: 5px;
        }

        .hidden {
            display: none !important;
        }

        @media (max-width: 360px) {
            .main-timer {
                font-size: 28px;
            }

            .stat-val {
                font-size: 14px;
            }

            .btn {
                padding: 12px 8px;
            }
        }
    </style>
</head>

<body>
    <div class="viewport">
        <!-- START OVERLAY -->
        <div id="startOverlay" class="overlay">
            <span class="project-tag">FILM TIMER PRO</span>
            <h1 style="margin: 10px 0 0; font-size: 26px; font-weight: 800;">–°–ú–ï–ù–ê –ù–ï –ù–ê–ß–ê–¢–ê</h1>
            <p id="startOverlayDesc"
                style="font-size: 15px; color: var(--text-dim); margin: 12px 0 20px; max-width: 260px; line-height: 1.5;">
                –í—ã–±–µ—Ä–∏—Ç–µ –∑–∞–ø–ª–∞–Ω–∏—Ä–æ–≤–∞–Ω–Ω—É—é —Å—ä–µ–º–∫—É –∏–ª–∏ –Ω–∞—á–Ω–∏—Ç–µ –Ω–æ–≤—É—é —Å–∞–º–æ—Å—Ç–æ—è—Ç–µ–ª—å–Ω–æ.</p>

            <div id="shootSelector" class="opt-list" style="width: 100%; max-width: 300px; margin-bottom: 20px;">
                <!-- Shoots will be rendered here -->
                <div class="opt-item" style="border-color: var(--accent-blue); color: var(--accent-blue);"
                    onclick="startManualShift()">‚ûï –ù–û–í–ê–Ø –°–ú–ï–ù–ê (–í–†–£–ß–ù–£–Æ)</div>
            </div>

            <button id="btnMainStart" class="start-ring hidden">–ù–ê–ß–ê–¢–¨ –°–ú–ï–ù–£</button>
        </div>

        <!-- HEADER -->
        <div class="header">
            <span class="project-tag" id="elProjName">PROJECT_NAME</span>
            <div id="elShiftTimer" class="main-timer">00:00:00</div>
            <div id="elLocation" class="location-tag">üìç <span id="valLocation">–õ–û–ö–ê–¶–ò–Ø: –ö–í–ê–†–¢–ò–†–ê</span> ‚öôÔ∏è</div>
        </div>

        <!-- STATUS -->
        <div class="status-bar">
            <div class="status-info">
                <div id="elStatusDot" class="dot active"></div>
                <span id="elPhaseLabel">–û–ñ–ò–î–ê–ù–ò–ï</span>
            </div>
            <div id="elPhaseTimer" class="phase-timer">00:00</div>
        </div>

        <!-- CONTROLS -->
        <div id="controls" class="controls">
            <!-- 1. –ì–õ–û–ë–ê–õ–¨–ù–´–ï -->
            <div class="section">
                <div class="section-header">–ì–õ–û–ë–ê–õ–¨–ù–´–ï / –¢–ê–ô–ú–ò–ù–ì</div>
                <div class="grid">
                    <div id="btn_travel" class="btn" onclick="toggleBtn('travel', '–î–í–ò–ñ–ï–ù–ò–ï', '–î–í–ò–ñ–ï–ù–ò–ï')"><span
                            class="btn-label">–ï–¥–µ–º</span><span class="btn-val">TRAVEL TO LOC</span>
                        <div class="btn-timer">00:00</div>
                    </div>
                    <div id="btn_onsite" class="btn" onclick="showCrewChecklist()"><span class="btn-label">–ù–∞
                            –º–µ—Å—Ç–µ</span><span class="btn-val">ON SITE</span>
                        <div class="btn-timer">00:00</div>
                    </div>
                </div>
            </div>

            <!-- 2. –ü–†–ò–ë–´–¢–ò–ï -->
            <div class="section">
                <div class="section-header">–ü–†–ò–ë–´–¢–ò–ï (CHECK-IN)</div>
                <div class="grid">
                    <div class="btn" onclick="logEvent('crew_arrival', {}, true)"><span
                            class="btn-label">–ì—Ä—É–ø–ø–∞</span><span class="btn-val">CREW ARRIVAL</span></div>
                    <div class="btn" onclick="logEvent('client_arrival', {}, true)"><span
                            class="btn-label">–ó–∞–∫–∞–∑—á–∏–∫</span><span class="btn-val">CLIENT / AGENCY</span></div>
                    <div class="btn" style="grid-column: span 2" onclick="showOptionModal('actor_checkin')"><span
                            class="btn-label">–ê–∫—Ç–µ—Ä—ã</span><span class="btn-val">ACTOR CHECK-IN</span></div>
                </div>
            </div>

            <!-- 3. –ü–û–î–ì–û–¢–û–í–ö–ê –ê–ö–¢–ï–†–û–í -->
            <div class="section">
                <div class="section-header">–ü–û–î–ì–û–¢–û–í–ö–ê –ê–ö–¢–ï–†–û–í</div>
                <div class="grid">
                    <div id="btn_makeup" class="btn c-blue" data-prep="makeup"><span
                            class="btn-label">–ù–∞—á–∞–ª–æ/–ö–æ–Ω–µ—Ü</span><span class="btn-val">–ì–†–ò–ú</span>
                        <div class="btn-timer">00:00</div>
                    </div>
                    <div id="btn_wardrobe" class="btn c-blue" data-prep="wardrobe"><span
                            class="btn-label">–ù–∞—á–∞–ª–æ/–ö–æ–Ω–µ—Ü</span><span class="btn-val">–ö–û–°–¢–Æ–ú</span>
                        <div class="btn-timer">00:00</div>
                    </div>
                    <div id="btn_sound" class="btn c-blue" data-prep="sound_rigging"><span
                            class="btn-label">–£—Å—Ç–∞–Ω–æ–≤–∫–∞</span><span class="btn-val">–û–ü–ï–¢–õ–ò–ß–ò–í–ê–ù–ò–ï</span>
                        <div class="btn-timer">00:00</div>
                    </div>
                    <div class="btn c-green" onclick="logEvent('actor_ready', {}, true)"><span
                            class="btn-label">–§–∏–Ω–∞–ª—å–Ω—ã–π —Å—Ç–∞—Ç—É—Å</span><span class="btn-val">–ê–ö–¢–ï–† –ì–û–¢–û–í</span></div>
                </div>
            </div>

            <!-- 4. –¢–ï–•–ù–ò–ß–ï–°–ö–ê–Ø –ü–û–î–ì–û–¢–û–í–ö–ê -->
            <div class="section">
                <div class="section-header">–¢–ï–•–ù–ò–ß–ï–°–ö–ê–Ø –ü–û–î–ì–û–¢–û–í–ö–ê</div>
                <div class="grid">
                    <div id="btn_light_set" class="btn c-yellow"
                        onclick="toggleBtn('light_set', '–í–´–°–¢. –°–í–ï–¢–ê', '–°–í–ï–¢ –°–¢–ê–†–¢')"><span
                            class="btn-label">–ü–µ—Ä–≤–∏—á–Ω—ã–π</span><span class="btn-val">–í–´–°–¢. –°–í–ï–¢–ê</span>
                        <div class="btn-timer">00:00</div>
                    </div>
                    <div id="btn_light_adj" class="btn c-yellow"
                        onclick="toggleBtn('light_adj', '–ü–ï–†–ï–°–¢. –°–í–ï–¢–ê', '–ü–†–ê–í–ö–ò –°–í–ï–¢–ê')"><span
                            class="btn-label">–ü—Ä–∞–≤–∫–∏</span><span class="btn-val">–ü–ï–†–ï–°–¢. –°–í–ï–¢–ê</span>
                        <div class="btn-timer">00:00</div>
                    </div>
                    <div id="btn_cam_prep" class="btn c-yellow"
                        onclick="toggleBtn('cam_prep', '–ö–ê–ú–ï–†–ê –ü–†–ï–î', '–¢–ï–•–ù–ò–ö–ê')"><span class="btn-label">–ö—Ä–∞–Ω /
                            –û–ø—Ç–∏–∫–∞</span><span class="btn-val">–ö–ê–ú–ï–†–ê –ü–†–ï–î</span>
                        <div class="btn-timer">00:00</div>
                    </div>
                    <div id="btn_art_dept" class="btn c-yellow" onclick="toggleBtn('art_dept', '–•–£–î–û–ñ–ù–ò–ö–ò', '–ê–†–¢-–¶–ï–•')">
                        <span class="btn-label">–†–µ–∫–≤–∏–∑–∏—Ç</span><span class="btn-val">–•–£–î–û–ñ–ù–ò–ö–ò</span>
                        <div class="btn-timer">00:00</div>
                    </div>
                    <div id="btn_sfx" class="btn c-orange" style="grid-column: span 2"
                        onclick="toggleBtn('sfx', '–°–§–ï–ö–° / –î–´–ú', 'SFX –ü–†–ï–î')"><span
                            class="btn-label">–°–ø–µ—Ü—ç—Ñ—Ñ–µ–∫—Ç—ã</span><span class="btn-val">–°–§–ï–ö–° / –î–´–ú –ü–†–ï–î</span>
                        <div class="btn-timer">00:00</div>
                    </div>
                </div>
            </div>

            <!-- 5. –†–ï–ü–ï–¢–ò–¶–ò–ò –ò –°–™–ï–ú–ö–ê -->
            <div class="section">
                <div class="section-header">–†–ï–ü–ï–¢–ò–¶–ò–ò –ò –°–™–ï–ú–ö–ê</div>
                <div class="grid">
                    <div id="btnMotor" class="btn btn-motor-main c-red"><span class="btn-label">–ó–∞–ø–∏—Å—å</span><span
                            id="motorTitle" class="btn-val">–ú–û–¢–û–†</span></div>
                    <div id="btn_blocking" class="btn c-green"
                        onclick="toggleBtn('blocking', '–ë–õ–û–ö–ò–†–û–í–ö–ê', '–ú–ò–ó–ê–ù–°–¶–ï–ù–ê')"><span
                            class="btn-label">–ú–∏–∑–∞–Ω—Å—Ü–µ–Ω–∞</span><span class="btn-val">–ë–õ–û–ö–ò–†–û–í–ö–ê</span>
                        <div class="btn-timer">00:00</div>
                    </div>
                    <div id="btn_rehearsal" class="btn c-green" onclick="toggleBtn('rehearsal', '–†–ï–ü–ï–¢–ò–¶–ò–Ø', '–ü–†–û–ì–û–ù')">
                        <span class="btn-label">–ë–µ–∑ –∫–∞–º–µ—Ä—ã</span><span class="btn-val">–†–ï–ü–ï–¢–ò–¶–ò–Ø</span>
                        <div class="btn-timer">00:00</div>
                    </div>
                    <div id="btn_dress_reh" class="btn c-green"
                        onclick="toggleBtn('dress_reh', '–ì–ï–ù. –†–ï–ü–ï–¢–ò–¶–ò–Ø', '–ì–ï–ù–ï–†–ê–õ–¨–ù–ê–Ø')"><span class="btn-label">–í
                            –∫–æ—Å—Ç—é–º–∞—Ö</span><span class="btn-val">–ì–ï–ù. –†–ï–ü–ï–¢–ò–¶–ò–Ø</span>
                        <div class="btn-timer">00:00</div>
                    </div>
                    <div id="btn_series" class="btn c-orange" onclick="toggleBtn('series', '–°–ï–†–ò–Ø', '–°–ï–†–ò–Ø –î–£–ë–õ–ï–ô')">
                        <span class="btn-label">–ú–Ω–æ–≥–æ –¥—É–±–ª–µ–π</span><span class="btn-val">–°–ï–†–ò–Ø</span>
                        <div class="btn-timer">00:00</div>
                    </div>
                    <div class="btn" onclick="showOptionModal('next_scene')"><span
                            class="btn-label">–°—Ü–µ–Ω–∞—Ä–∏—è</span><span class="btn-val">–°–¶–ï–ù–ê + 1</span></div>
                </div>
            </div>

            <!-- 6. –õ–û–ì–ò–°–¢–ò–ö–ê -->
            <div class="section">
                <div class="section-header">–õ–û–ì–ò–°–¢–ò–ö–ê –ò –ü–ï–†–ï–†–´–í–´</div>
                <div class="grid">
                    <div id="btn_lunch" class="btn c-blue" onclick="toggleBtn('lunch', '–û–ë–ï–î', '–ü–ï–†–ï–†–´–í –ü–ò–¢–ê–ù–ò–ï')"><span
                            class="btn-label">–û–±–µ–¥</span><span class="btn-val">–û–ë–ï–î / LUNCH</span>
                        <div class="btn-timer">00:00</div>
                    </div>
                    <div id="btn_tech_break" class="btn c-blue"
                        onclick="toggleBtn('tech_break', '–¢–ï–•. –ü–ï–†–ï–†–´–í', '–¢–ï–•. –ü–ï–†–ï–†–´–í')"><span
                            class="btn-label">–ü–µ—Ä–µ—Ä—ã–≤</span><span class="btn-val">–¢–ï–•. –ü–ï–†–ï–†–´–í</span>
                        <div class="btn-timer">00:00</div>
                    </div>
                    <div class="btn c-blue" onclick="showOptionModal('location_change')"><span class="btn-label">–°–º–µ–Ω–∞
                            –æ–±—ä–µ–∫—Ç–∞</span><span class="btn-val">–ü–ï–†–ï–ï–ó–î</span></div>
                    <div class="btn c-blue" onclick="logEvent('catering_arrival', {}, true)"><span
                            class="btn-label">–ì–æ—Ä—è—á–µ–µ</span><span class="btn-val">–ë–£–§–ï–¢ –ü–†–ò–ï–•–ê–õ</span></div>
                </div>
            </div>

            <!-- 7. –ó–ê–î–ï–†–ñ–ö–ò -->
            <div class="section">
                <div class="section-header">–ó–ê–î–ï–†–ñ–ö–ò (DELAYS)</div>
                <div class="grid">
                    <div id="btn_delay_tech" class="btn c-orange" onclick="toggleDelay('tech')"><span
                            class="btn-label">–ü—Ä–æ–±–ª–µ–º–∞</span><span class="btn-val">TECH</span>
                        <div class="btn-timer">00:00</div>
                    </div>
                    <div id="btn_delay_crew" class="btn c-orange" onclick="toggleDelay('crew')"><span
                            class="btn-label">–ü—Ä–æ–±–ª–µ–º–∞</span><span class="btn-val">CREW</span>
                        <div class="btn-timer">00:00</div>
                    </div>
                    <div id="btn_delay_actor" class="btn c-orange" onclick="toggleDelay('actor')"><span
                            class="btn-label">–ü—Ä–æ–±–ª–µ–º–∞</span><span class="btn-val">ACTOR</span>
                        <div class="btn-timer">00:00</div>
                    </div>
                    <div id="btn_delay_client" class="btn c-orange" onclick="toggleDelay('client')"><span
                            class="btn-label">–ü—Ä–æ–±–ª–µ–º–∞</span><span class="btn-val">CLIENT</span>
                        <div class="btn-timer">00:00</div>
                    </div>
                    <div id="btn_delay_weather" class="btn c-orange" onclick="toggleDelay('weather')"><span
                            class="btn-label">–ü—Ä–æ–±–ª–µ–º–∞</span><span class="btn-val">WEATHER</span>
                        <div class="btn-timer">00:00</div>
                    </div>
                    <div id="btn_delay_noise" class="btn c-orange" onclick="toggleDelay('noise')"><span
                            class="btn-label">–ü—Ä–æ–±–ª–µ–º–∞</span><span class="btn-val">NOISE</span>
                        <div class="btn-timer">00:00</div>
                    </div>
                </div>
            </div>

            <!-- 8. –î–û–ü–û–õ–ù–ò–¢–ï–õ–¨–ù–û -->
            <div class="section">
                <div class="section-header">–î–û–ü–û–õ–ù–ò–¢–ï–õ–¨–ù–û</div>
                <div class="grid">
                    <div id="btn_dit" class="btn" onclick="toggleBtn('dit', 'BACKUP', '–°–õ–ò–í –ú–ê–¢–ï–†–ò–ê–õ–ê')"><span
                            class="btn-label">DIT</span><span class="btn-val">BACKUP</span>
                        <div class="btn-timer">00:00</div>
                    </div>
                    <div id="btn_bts" class="btn" onclick="toggleBtn('bts', 'MARKETING', '–ë–ï–ö–°–¢–ï–ô–î–ñ / BTS')"><span
                            class="btn-label">–ú–∞—Ä–∫–µ—Ç–∏–Ω–≥</span><span class="btn-val">BTS / PHOTO</span>
                        <div class="btn-timer">00:00</div>
                    </div>
                    <div id="btn_police" class="btn" onclick="toggleBtn('police', 'POLICE', '–ü–†–û–í–ï–†–ö–ê –í–õ–ê–°–¢–ò')"><span
                            class="btn-label">–í–ª–∞—Å—Ç—å</span><span class="btn-val">POLICE</span>
                        <div class="btn-timer">00:00</div>
                    </div>
                    <div class="btn c-blue" onclick="showOptionModal('note')"><span
                            class="btn-label">–ó–∞–º–µ—Ç–∫–∞</span><span class="btn-val">MEMO</span></div>
                </div>
            </div>

            <!-- 9. –ó–ê–í–ï–†–®–ï–ù–ò–ï -->
            <div class="section">
                <div class="section-header">–ó–ê–í–ï–†–®–ï–ù–ò–ï –°–™–ï–ú–ö–ò</div>
                <div class="grid">
                    <div class="btn c-red" onclick="logEvent('wrap', {}, true)"><span class="btn-label">–§–∏–Ω–∞–ª
                            —Å—ä–µ–º–∫–∏</span><span class="btn-val">WRAP (STOP CAM)</span></div>
                    <div class="btn c-red" onclick="logEvent('last_man_out', {}, true)"><span
                            class="btn-label">–ü–æ—Å–ª–µ–¥–Ω–∏–π —á–µ–ª–æ–≤–µ–∫</span><span class="btn-val">LAST MAN OUT</span></div>
                </div>
            </div>
        </div>

        <!-- FOOTER -->
        <div class="footer">
            <div class="stat" onclick="showOptionModal('next_scene')">
                <div class="stat-label">–°–¶–ï–ù–ê</div>
                <div id="valScene" class="stat-val">1</div>
            </div>
            <div class="stat" id="elShotBtn">
                <div class="stat-label">–ö–ê–î–†</div>
                <div id="valShot" class="stat-val">1</div>
            </div>
            <div class="stat" id="elTakeBtn">
                <div class="stat-label">–î–£–ë–õ–¨</div>
                <div id="valTake" class="stat-val">0</div>
            </div>
            <div class="stat" style="color: var(--accent-red)" id="btnFinalWrap">
                <div class="stat-label">FINISH</div>
                <div id="btnFinalWrapVal" class="stat-val">–°–ú–ï–ù–ê</div>
            </div>
        </div>
    </div>

    <!-- MODAL -->
    <div id="modal" class="modal">
        <div id="modalBox" class="modal-box">
            <h3 id="modalTitle" class="m-title">Title</h3>
            <p id="modalDesc" class="m-desc">Description</p>
            <div id="modalOptions" class="opt-list hidden"></div>
            <div id="modalButtons" class="m-grid">
                <button id="btnModalConfirm" class="m-btn m-confirm">–ü–û–î–¢–í–ï–†–î–ò–¢–¨</button>
                <button id="btnModalCancel" class="m-btn m-cancel">–û–¢–ú–ï–ù–ê</button>
            </div>
        </div>
    </div>

    <script>
        const tg = window.Telegram.WebApp;
        tg.expand();
        tg.enableClosingConfirmation();

        const SUPABASE_URL = "https://waekzofajzqcpoeldhkt.supabase.co";
        const SUPABASE_KEY = "sb_publishable_XVByRUkaKbM-11ChwOd2Aw_y24CSb4V";
        const sb = supabase.createClient(SUPABASE_URL, SUPABASE_KEY);

        const params = new URLSearchParams(window.location.search);
        const PID = params.get('pid') || '0';

        // Namespaced helpers
        const pKey = (k) => `p${PID}_${k}`;
        const pGet = (k) => localStorage.getItem(pKey(k));
        const pSet = (k, v) => localStorage.setItem(pKey(k), v);
        const pRem = (k) => localStorage.removeItem(pKey(k));

        let state = {
            shiftId: pGet('shift_id'),
            shootId: pGet('shoot_id'),
            startTime: pGet('start_time'),
            status: pGet('status') || 'inactive',
            phase: pGet('phase') || 'IDLE',
            phaseStartTime: pGet('phase_start') || null,
            location: pGet('location') || '–ö–í–ê–†–¢–ò–†–ê',
            scene: parseInt(pGet('scene')) || 1,
            shot: parseInt(pGet('shot')) || 1,
            take: parseInt(pGet('take')) || 0,
            isMotor: false,
            project: { id: PID, name: '...' },
            shootCrew: [],
            arrivedCrew: JSON.parse(pGet('arrived_crew') || '[]'),
            activeTimers: JSON.parse(pGet('active_timers') || '{}')
        };

        const ui = {
            overlay: document.getElementById('startOverlay'),
            shiftTimer: document.getElementById('elShiftTimer'),
            phaseTimer: document.getElementById('elPhaseTimer'),
            phaseLabel: document.getElementById('elPhaseLabel'),
            locationLabel: document.getElementById('valLocation'),
            sceneLabel: document.getElementById('valScene'),
            shotLabel: document.getElementById('valShot'),
            takeLabel: document.getElementById('valTake'),
            motorBtn: document.getElementById('btnMotor'),
            motorTitle: document.getElementById('motorTitle'),
            modal: document.getElementById('modal'),
            modalTitle: document.getElementById('modalTitle'),
            modalDesc: document.getElementById('modalDesc'),
            modalOptions: document.getElementById('modalOptions'),
            modalButtons: document.getElementById('modalButtons'),
            controls: document.getElementById('controls')
        };

        async function initApp() {
            state.project = {
                id: PID,
                name: params.get('proj') || '–ü—Ä–æ–µ–∫—Ç',
                cid: params.get('cid'),
                tid: params.get('tid')
            };
            document.getElementById('elProjName').textContent = state.project.name;
            ui.locationLabel.textContent = `–õ–û–ö–ê–¶–ò–Ø: ${state.location}`;
            ui.sceneLabel.textContent = state.scene;
            ui.shotLabel.textContent = state.shot;
            ui.takeLabel.textContent = state.take;
            ui.phaseLabel.textContent = pGet('phase_label') || '–û–ñ–ò–î–ê–ù–ò–ï';

            if (state.status === 'active') {
                ui.overlay.classList.add('hidden');
                refreshUI();
            } else {
                await checkCalendar();
                ui.overlay.classList.remove('hidden'); // Ensure overlay is visible for selection
            }
        }

        async function checkCalendar() {
            // Use Local Date instead of UTC ISO to match index.html logic
            const d = new Date();
            const localDate = `${d.getFullYear()}-${String(d.getMonth() + 1).padStart(2, '0')}-${String(d.getDate()).padStart(2, '0')}`;

            const { data, error } = await sb.from('shoots')
                .select('*')
                .eq('date', localDate);

            const container = document.getElementById('shootSelector');
            container.innerHTML = `<div class="opt-item" style="border-color: var(--accent-blue); color: var(--accent-blue);" onclick="startManualShift()">‚ûï –ù–û–í–ê–Ø –°–ú–ï–ù–ê (–í–†–£–ß–ù–£–Æ)</div>`;

            if (data && data.length > 0) {
                // Try to filter by project name (case-insensitive and trimmed)
                let matches = data.filter(s =>
                    s.project.trim().toLowerCase() === state.project.name.trim().toLowerCase()
                );

                // If no project-specific matches, but there are shoots, maybe show all (as fallback)
                // or if we found matches, use those. 
                // Let's stick to specific matches but be flexible.
                if (matches.length === 0) {
                    console.log("No specific project matches. Showing all shoots for today as fallback.");
                    matches = data;
                }

                matches.forEach(s => {
                    const div = document.createElement('div');
                    div.className = 'opt-item';
                    const isSpecific = s.project.trim().toLowerCase() === state.project.name.trim().toLowerCase();
                    div.innerHTML = `<small style="display:block; opacity:0.6; font-size:9px">${isSpecific ? '–í –ü–õ–ê–ù–ï –ü–†–û–ï–ö–¢–ê' : s.project.toUpperCase()}</small>${s.location} <span style="color:var(--accent-yellow)">${s.callTime || ''}</span>`;
                    div.onclick = () => selectShoot(s);
                    container.prepend(div);
                });
            }
        }

        async function selectShoot(shoot) {
            state.shootId = shoot.id;
            state.location = shoot.location;
            state.shootCrew = (shoot.crew || '').split(',').map(s => s.trim()).filter(s => s);
            ui.locationLabel.textContent = `–õ–û–ö–ê–¶–ò–Ø: ${state.location}`;
            saveState();
            startSequence();
        }

        async function showCrewChecklist() {
            if (!state.shiftId) return;
            if (!state.shootCrew.length && state.shootId && state.shootId !== 'manual') {
                const { data } = await sb.from('shoots').select('crew').eq('id', state.shootId).single();
                if (data) state.shootCrew = (data.crew || '').split(',').map(s => s.trim()).filter(s => s);
            }

            if (!state.shootCrew.length) {
                // Fallback to manual phase toggle if no crew list
                if (!state.activeTimers['onsite']) toggleBtn('onsite', '–†–ê–ó–í–ï–†–¢.', '–ù–ê –ú–ï–°–¢–ï');
                else alert("–°–ø–∏—Å–æ–∫ –≥—Ä—É–ø–ø—ã –ø—É—Å—Ç.");
                return;
            }

            const options = state.shootCrew.map(name => ({
                l: name,
                v: name,
                selected: state.arrivedCrew.includes(name)
            }));

            showChecklistModal("–ö–¢–û –ù–ê –ú–ï–°–¢–ï?", "–û—Ç–º–µ—Ç—å—Ç–µ –ø—Ä–∏–±—ã–≤—à–∏—Ö —É—á–∞—Å—Ç–Ω–∏–∫–æ–≤ –≥—Ä—É–ø–ø—ã:", options, (selected) => {
                const now = new Date().toISOString();
                let newlyArrived = [];
                selected.forEach(name => {
                    if (!state.arrivedCrew.includes(name)) {
                        state.arrivedCrew.push(name);
                        newlyArrived.push(name);
                        // Log event for each individual
                        logEvent('crew_arrival', { name: name });
                    }
                });

                if (newlyArrived.length > 0) {
                    tg.HapticFeedback.notificationOccurred('success');
                    flashStatusBar();
                }

                // If this is the first check-in, also start the 'onsite' phase timer if not active
                if (!state.activeTimers['onsite']) {
                    toggleBtn('onsite', '–†–ê–ó–í–ï–†–¢.', '–ù–ê –ú–ï–°–¢–ï');
                }

                saveState();
            });
        }

        function showChecklistModal(title, desc, options, onConfirm) {
            ui.modalTitle.textContent = title; ui.modalDesc.textContent = desc;
            ui.modalOptions.innerHTML = ''; ui.modalOptions.classList.remove('hidden');
            ui.modalButtons.classList.remove('hidden');
            ui.modal.style.display = 'flex';

            const checkboxes = [];
            options.forEach(o => {
                const div = document.createElement('div');
                div.className = 'opt-item';
                div.style.display = 'flex';
                div.style.justifyContent = 'space-between';
                div.style.alignItems = 'center';
                div.innerHTML = `<span>${o.l}</span><input type="checkbox" style="width:20px;height:20px" ${o.selected ? 'checked disabled' : ''}>`;

                const cb = div.querySelector('input');
                div.onclick = () => { if (!o.selected) cb.checked = !cb.checked; };
                ui.modalOptions.appendChild(div);
                checkboxes.push({ v: o.v, cb: cb, already: o.selected });
            });

            document.getElementById('btnModalConfirm').onclick = () => {
                ui.modal.style.display = 'none';
                const selected = checkboxes.filter(c => c.cb.checked && !c.already).map(c => c.v);
                onConfirm(selected);
            };
            document.getElementById('btnModalCancel').onclick = () => { ui.modal.style.display = 'none'; };
        }

        function startManualShift() {
            const loc = prompt("–í–≤–µ–¥–∏—Ç–µ –ª–æ–∫–∞—Ü–∏—é (–û–±—ä–µ–∫—Ç):", state.location);
            if (loc) {
                state.location = loc;
                state.shootId = 'manual';
                state.shootCrew = []; // No predefined crew for manual
                ui.locationLabel.textContent = `–õ–û–ö–ê–¶–ò–Ø: ${loc}`;
                saveState();
                startSequence();
            }
        }

        function startSequence() {
            startStep = 0;
            showConfirm(startChecks[0].t, startChecks[0].d, () => nextStartStep());
        }

        function saveState() {
            pSet('shift_id', state.shiftId || '');
            pSet('shoot_id', state.shootId || '');
            pSet('start_time', state.startTime || '');
            pSet('status', state.status);
            pSet('location', state.location);
            pSet('scene', state.scene);
            pSet('shot', state.shot);
            pSet('take', state.take);
            pSet('phase', state.phase);
            pSet('phase_start', state.phaseStartTime || '');
            pSet('phase_label', ui.phaseLabel.textContent);
            pSet('arrived_crew', JSON.stringify(state.arrivedCrew));
            pSet('active_timers', JSON.stringify(state.activeTimers));
        }

        async function logEvent(type, data = {}, blink = false) {
            if (!state.shiftId) return;
            try {
                const entry = {
                    shift_id: state.shiftId,
                    event_type: type,
                    data: { ...data, scene_no: state.scene, shot_no: state.shot, take_no: state.take, loc: state.location, shoot_id: state.shootId }
                };
                sb.from('production_logs').insert(entry).then();
                tg.HapticFeedback.impactOccurred('light');
                if (blink) flashStatusBar();
            } catch (e) { console.error(e); }
        }

        function flashStatusBar() {
            const bar = document.querySelector('.status-bar');
            bar.style.borderColor = 'var(--accent-green)';
            bar.style.background = 'rgba(52, 199, 89, 0.1)';
            setTimeout(() => {
                bar.style.borderColor = 'var(--border)';
                bar.style.background = 'var(--glass)';
            }, 500);
        }

        setInterval(() => {
            if (state.startTime) {
                const diff = new Date() - new Date(state.startTime);
                ui.shiftTimer.textContent = formatTime(diff);
            }
            if (state.phaseStartTime) {
                const diff = new Date() - new Date(state.phaseStartTime);
                ui.phaseTimer.textContent = formatTimeShort(diff);
            }
            // Button Timers
            for (let id in state.activeTimers) {
                const el = document.getElementById('btn_' + id);
                if (el) {
                    const timerEl = el.querySelector('.btn-timer');
                    const start = new Date(state.activeTimers[id]);
                    const diff = new Date() - start;

                    if (id === 'makeup' || id === 'wardrobe' || id === 'sound') {
                        const promised = parseInt(pGet('promised_' + id) || 0) * 60000;
                        const remaining = promised - diff;
                        if (remaining < 0) {
                            timerEl.textContent = '-' + formatTimeShort(Math.abs(remaining));
                            timerEl.style.color = 'var(--accent-red)';
                        } else {
                            timerEl.textContent = formatTimeShort(remaining);
                            timerEl.style.color = 'var(--accent-yellow)';
                        }
                    } else {
                        timerEl.textContent = formatTimeShort(diff);
                    }
                }
            }
        }, 1000);

        function formatTime(ms) {
            const h = Math.floor(ms / 3600000);
            const m = Math.floor((ms % 3600000) / 60000);
            const s = Math.floor((ms % 60000) / 1000);
            return `${h.toString().padStart(2, '0')}:${m.toString().padStart(2, '0')}:${s.toString().padStart(2, '0')}`;
        }
        function formatTimeShort(ms) {
            const m = Math.floor(ms / 60000);
            const s = Math.floor((ms % 60000) / 1000);
            return `${m.toString().padStart(2, '0')}:${s.toString().padStart(2, '0')}`;
        }

        function toggleBtn(id, label, phaseLabel) {
            const el = document.getElementById('btn_' + id);
            if (state.activeTimers[id]) {
                const dur = Math.round((new Date() - new Date(state.activeTimers[id])) / 60000);
                logEvent(id + '_end', { duration_m: dur });
                delete state.activeTimers[id];
                el.classList.remove('active');
                setPhase('IDLE', '–û–ñ–ò–î–ê–ù–ò–ï');
            } else {
                state.activeTimers[id] = new Date().toISOString();
                el.classList.add('active');
                logEvent(id + '_start');
                setPhase(id.toUpperCase(), phaseLabel);
            }
            saveState();
        }

        function toggleDelay(category) {
            const id = 'delay_' + category;
            const el = document.getElementById('btn_' + id);
            if (state.activeTimers[id]) {
                const res = prompt("–ö–∞–∫ —Ä–µ—à–∏–ª–∏ –ø—Ä–æ–±–ª–µ–º—É?", "–£—Å—Ç—Ä–∞–Ω–µ–Ω–æ");
                if (res !== null) {
                    const dur = Math.round((new Date() - new Date(state.activeTimers[id])) / 60000);
                    logEvent(id + '_end', { resolution: res, duration_m: dur });
                    delete state.activeTimers[id];
                    el.classList.remove('active');
                    saveState();
                }
            } else {
                const reason = prompt("–ü—Ä–∏—á–∏–Ω–∞ –∑–∞–¥–µ—Ä–∂–∫–∏:", "");
                if (reason !== null) {
                    state.activeTimers[id] = new Date().toISOString();
                    el.classList.add('active');
                    logEvent(id + '_start', { reason: reason });
                    setPhase('DELAY', '–ó–ê–î–ï–†–ñ–ö–ê: ' + category.toUpperCase());
                    saveState();
                }
            }
        }

        document.querySelectorAll('[data-prep]').forEach(el => {
            el.onclick = () => {
                const id = el.getAttribute('data-prep');
                if (state.activeTimers[id]) {
                    const dur = Math.round((new Date() - new Date(state.activeTimers[id])) / 60000);
                    const promised = parseInt(localStorage.getItem('promised_' + id));
                    const delay = Math.max(0, dur - promised);
                    logEvent(id + '_end', { duration_m: dur, delay_m: delay });
                    delete state.activeTimers[id];
                    el.classList.remove('active');
                    setPhase('IDLE', '–û–ñ–ò–î–ê–ù–ò–ï');
                    saveState();
                } else {
                    showOptions("–°–ö–û–õ–¨–ö–û –ú–ò–ù–£–¢?", `–ü–ª–∞–Ω –Ω–∞ ${id.toUpperCase()}:`, [
                        { l: "5 –ú–ò–ù", v: "5" }, { l: "15 –ú–ò–ù", v: "15" }, { l: "30 –ú–ò–ù", v: "30" }, { l: "–°–í–û–ô –í–ê–†–ò–ê–ù–¢", v: "custom" }
                    ], (val) => {
                        let mins = (val === 'custom') ? prompt("–ú–∏–Ω—É—Ç:", "20") : val;
                        if (mins) {
                            state.activeTimers[id] = new Date().toISOString();
                            localStorage.setItem('promised_' + id, mins);
                            el.classList.add('active');
                            logEvent(id + '_start', { promised: mins });
                            setPhase(id.toUpperCase(), id.toUpperCase());
                            saveState();
                        }
                    });
                }
            };
        });

        function refreshUI() {
            for (let id in state.activeTimers) {
                const el = document.getElementById('btn_' + id) || document.getElementById('btn_delay_' + id);
                if (el) el.classList.add('active');
            }
        }

        document.getElementById('btnMainStart').onclick = () => {
            startStep = 0;
            showConfirm(startChecks[0].t, startChecks[0].d, () => nextStartStep());
        };

        let startStep = 0;
        const startChecks = [
            { t: "–ù–ê–ß–ò–ù–ê–ï–ú –°–ú–ï–ù–£?", d: "–í—ã –≥–æ—Ç–æ–≤—ã –∑–∞–ø—É—Å—Ç–∏—Ç—å —Ç–∞–π–º–µ—Ä?" },
            { t: "–í–°–ï –¶–ï–•–ê –ì–û–¢–û–í–´?", d: "–ü—Ä–∏–±—ã–ª –ª–∏ –≤–µ—Å—å –ø–µ—Ä—Å–æ–Ω–∞–ª –∏ —Ç–µ—Ö–Ω–∏–∫–∞?" },
            { t: "–ê–ö–¢–ï–†–´ –ù–ê –ü–õ–û–©–ê–î–ö–ï?", d: "–ê–∫—Ç–µ—Ä—ã –≥–æ—Ç–æ–≤—ã –∫ –Ω–∞—á–∞–ª—É —Ä–∞–±–æ—Ç—ã?" },
            { t: "–ó–ê–ü–£–°–¢–ò–¢–¨ –û–§–ò–¶–ò–ê–õ–¨–ù–û?", d: "–≠—Ç–æ –¥–µ–π—Å—Ç–≤–∏–µ –∑–∞—Ñ–∏–∫—Å–∏—Ä—É–µ—Ç –≤—Ä–µ–º—è –Ω–∞—á–∞–ª–∞ –≤ –æ—Ç—á–µ—Ç–µ." }
        ];

        function nextStartStep() {
            startStep++;
            if (startStep < startChecks.length) {
                showConfirm(startChecks[startStep].t, startChecks[startStep].d, () => nextStartStep());
            } else {
                doStart();
            }
        }

        async function doStart() {
            const now = new Date().toISOString();
            const { data, error } = await sb.from('production_shifts').insert({
                project_id: state.project.id,
                chat_id: state.project.cid,
                thread_id: state.project.tid,
                shoot_id: state.shootId,
                start_time: now,
                status: 'active'
            }).select();

            if (data && data[0]) {
                state.shiftId = data[0].id; state.startTime = now; state.status = 'active';
                state.phaseStartTime = now; ui.phaseLabel.textContent = '–°–¢–ê–†–¢ –°–ú–ï–ù–´';
                saveState(); ui.overlay.classList.add('hidden'); logEvent('shift_start');
                tg.HapticFeedback.notificationOccurred('success');
            }
        }

        function setPhase(code, label) {
            state.phase = code;
            state.phaseStartTime = new Date().toISOString();
            ui.phaseLabel.textContent = label;
            saveState();
        }

        ui.motorBtn.onclick = () => {
            state.isMotor = !state.isMotor;
            if (state.isMotor) {
                state.take++; ui.takeLabel.textContent = state.take;
                ui.motorBtn.classList.add('active'); ui.motorTitle.textContent = '–°–¢–û–ü';
                setPhase('MOTOR', '–°–™–ï–ú–ö–ê'); tg.HapticFeedback.impactOccurred('heavy');
                logEvent('motor');
            } else {
                ui.motorBtn.classList.remove('active'); ui.motorTitle.textContent = '–ú–û–¢–û–†';
                setPhase('CUT', '–ü–ê–£–ó–ê'); logEvent('cut'); showEvaluation();
            }
            saveState();
        };

        document.getElementById('elShotBtn').onclick = () => {
            state.shot++; ui.shotLabel.textContent = state.shot; state.take = 0; ui.takeLabel.textContent = 0;
            saveState(); logEvent('shot_increment', {}, true);
        };

        document.getElementById('elTakeBtn').onclick = () => {
            state.take++; ui.takeLabel.textContent = state.take; saveState(); logEvent('take_increment', {}, true);
        };

        function showEvaluation() {
            showOptions("–û—Ü–µ–Ω–∫–∞ –¥—É–±–ª—è", "–ö–∞–∫ –ø—Ä–æ—à–µ–ª –¥—É–±–ª—å?", [
                { l: "‚≠ê GOOD (–•–æ—Ä–æ—à–æ)", v: "good" },
                { l: "‚ùå BRAK (–ë—Ä–∞–∫)", v: "bad" },
                { l: "‚öôÔ∏è TECH (–¢–µ—Ö. –æ—à–∏–±–∫–∞)", v: "tech" }
            ], (val) => logEvent('take_evaluation', { result: val }));
        }

        document.getElementById('elLocation').onclick = () => {
            const loc = prompt("–ù–æ–≤–∞—è –ª–æ–∫–∞—Ü–∏—è (–û–±—ä–µ–∫—Ç):", state.location);
            if (loc) {
                state.location = loc; ui.locationLabel.textContent = `–õ–û–ö–ê–¶–ò–Ø: ${loc}`;
                saveState(); logEvent('location_change', { new_loc: loc });
                if (!state.activeTimers['travel']) toggleBtn('travel', '–î–í–ò–ñ–ï–ù–ò–ï', '–î–í–ò–ñ–ï–ù–ò–ï');
            }
        };

        function showOptionModal(type) {
            if (type === 'next_scene') {
                const next = prompt("–ù–æ–º–µ—Ä –Ω–æ–≤–æ–π —Å—Ü–µ–Ω—ã:", state.scene + 1);
                if (next) {
                    state.scene = parseInt(next); state.shot = 1; state.take = 0;
                    ui.sceneLabel.textContent = state.scene; ui.shotLabel.textContent = 1; ui.takeLabel.textContent = 0;
                    saveState(); logEvent('next_scene', {}, true);
                }
            } else if (type === 'actor_checkin') {
                const name = prompt("–ò–º—è –∞–∫—Ç–µ—Ä–∞:");
                if (name) logEvent('actor_arrival', { name }, true);
            } else if (type === 'note') {
                const txt = prompt("–ó–∞–º–µ—Ç–∫–∞ / –ö–æ–º–º–µ–Ω—Ç–∞—Ä–∏–π:");
                if (txt) logEvent('note', { text: txt }, true);
            }
        }

        document.getElementById('btnFinalWrap').onclick = () => {
            showConfirm("–ó–ê–í–ï–†–®–ò–¢–¨ –°–ú–ï–ù–£?", "–≠—Ç–æ –æ—Å—Ç–∞–Ω–æ–≤–∏—Ç —Ç–∞–π–º–µ—Ä –∏ –æ—Ç–ø—Ä–∞–≤–∏—Ç –æ—Ç—á–µ—Ç –≤ —á–∞—Ç.", () => finishShift());
        };

        async function finishShift() {
            const end = new Date().toISOString();
            await sb.from('production_shifts').update({ status: 'finished', end_time: end }).eq('id', state.shiftId);
            await logEvent('shift_finish');
            fetch('/api/timer/report', {
                method: 'POST', headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ shift_id: state.shiftId, chat_id: state.project.cid, thread_id: state.project.tid })
            });
            localStorage.clear(); tg.close();
        }

        function showConfirm(title, desc, onOk) {
            ui.modalTitle.textContent = title; ui.modalDesc.textContent = desc;
            ui.modalOptions.classList.add('hidden'); ui.modalButtons.classList.remove('hidden');
            ui.modal.style.display = 'flex';
            document.getElementById('btnModalConfirm').onclick = () => { ui.modal.style.display = 'none'; onOk(); };
            document.getElementById('btnModalCancel').onclick = () => { ui.modal.style.display = 'none'; };
        }

        function showOptions(title, desc, options, onSelect) {
            ui.modalTitle.textContent = title; ui.modalDesc.textContent = desc;
            ui.modalOptions.innerHTML = ''; ui.modalOptions.classList.remove('hidden');
            ui.modalButtons.classList.add('hidden');
            options.forEach(o => {
                const div = document.createElement('div'); div.className = 'opt-item'; div.textContent = o.l;
                div.onclick = () => { ui.modal.style.display = 'none'; onSelect(o.v); };
                ui.modalOptions.appendChild(div);
            });
            ui.modal.style.display = 'flex';
        }

        initApp();
    </script>
</body>

</html>