<!DOCTYPE html>
<html lang="ru">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Campot Media Feedback</title>
    <script src="https://telegram.org/js/telegram-web-app.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <style>
        :root {
            --bg: #000000;
            --card: #111111;
            --text: #ffffff;
            --lime: #ccff00;
            --red: #ff3b30;
            --gray: #333333;
            --input-bg: #1a1a1a;

            --font-main: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Helvetica, Arial, sans-serif;
        }

        body {
            background-color: var(--bg);
            color: var(--text);
            font-family: var(--font-main);
            margin: 0;
            padding: 20px;
            line-height: 1.5;
        }

        h1,
        h2,
        h3 {
            margin: 0 0 10px;
            font-weight: 700;
        }

        h1 {
            color: var(--lime);
            font-size: 24px;
            text-transform: uppercase;
            letter-spacing: 1px;
            margin-bottom: 20px;
        }

        h2 {
            font-size: 18px;
            color: var(--text);
            border-left: 3px solid var(--lime);
            padding-left: 10px;
            margin-top: 30px;
            margin-bottom: 15px;
        }

        .desc {
            color: #888;
            font-size: 13px;
            margin-bottom: 20px;
        }

        .card {
            background: var(--card);
            border-radius: 16px;
            padding: 20px;
            margin-bottom: 20px;
            border: 1px solid var(--gray);
        }

        label {
            display: block;
            margin-bottom: 8px;
            font-size: 14px;
            font-weight: 600;
            color: #ddd;
        }

        .help {
            font-size: 12px;
            color: #666;
            margin-bottom: 8px;
            display: block;
        }

        input[type="text"],
        input[type="number"],
        textarea,
        select {
            width: 100%;
            background: var(--input-bg);
            border: 1px solid var(--gray);
            color: white;
            padding: 12px;
            border-radius: 8px;
            font-size: 16px;
            outline: none;
            box-sizing: border-box;
            transition: border-color 0.2s;
        }

        input:focus,
        textarea:focus,
        select:focus {
            border-color: var(--lime);
        }

        textarea {
            min-height: 80px;
            resize: vertical;
        }

        .btn {
            background: var(--lime);
            color: black;
            font-weight: 800;
            text-transform: uppercase;
            border: none;
            padding: 16px;
            border-radius: 12px;
            width: 100%;
            font-size: 16px;
            cursor: pointer;
            margin-top: 20px;
        }

        .btn:active {
            transform: scale(0.98);
            opacity: 0.9;
        }

        .step {
            display: none;
        }

        .step.active {
            display: block;
        }

        .nav {
            display: flex;
            gap: 10px;
            margin-top: 20px;
        }

        .nav .back {
            background: var(--gray);
            color: white;
        }

        /* Custom Radio Buttons */
        .radio-group {
            display: flex;
            flex-direction: column;
            gap: 10px;
        }

        .radio-opt {
            background: var(--input-bg);
            padding: 12px;
            border-radius: 8px;
            border: 1px solid var(--gray);
            cursor: pointer;
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .radio-opt.selected {
            border-color: var(--lime);
            background: rgba(204, 255, 0, 0.05);
        }

        .circle {
            width: 16px;
            height: 16px;
            border-radius: 50%;
            border: 2px solid #555;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .radio-opt.selected .circle {
            border-color: var(--lime);
        }

        .radio-opt.selected .circle::after {
            content: "";
            width: 8px;
            height: 8px;
            background: var(--lime);
            border-radius: 50%;
        }
    </style>
</head>

<body>

    <h1>Campot Analytics</h1>
    <div class="desc">–ï–∂–µ–º–µ—Å—è—á–Ω–∞—è —Å–≤–µ—Ä–∫–∞ –º–µ—Ç—Ä–∏–∫. –ü–æ–∂–∞–ª—É–π—Å—Ç–∞, –∑–∞–ø–æ–ª–Ω–∏—Ç–µ —á–µ—Å—Ç–Ω–æ ‚Äî —ç—Ç–æ —Ç–æ–ø–ª–∏–≤–æ –¥–ª—è —Å—Ç—Ä–∞—Ç–µ–≥–∏–∏.</div>

    <form id="form">
        <!-- –ë–õ–û–ö 0: –ö–û–ù–¢–ê–ö–¢–´ -->
        <div class="card">
            <h2>0. –ö–æ–Ω—Ç–∞–∫—Ç—ã</h2>
            <div style="margin-bottom:15px">
                <label>Instagram (Login)</label>
                <input type="text" id="instagram" placeholder="@username" required>
            </div>
            <div style="margin-bottom:15px">
                <label>–í–∞—à–µ –ò–º—è</label>
                <input type="text" id="client_name" placeholder="–ò–≤–∞–Ω" required>
            </div>
            <div>
                <label>–¢–µ–ª–µ—Ñ–æ–Ω</label>
                <input type="text" id="phone" placeholder="+7..." required>
            </div>
        </div>

        <!-- –ë–õ–û–ö 1: –¶–ò–§–†–´ -->
        <div class="card">
            <h2>1. –ì–ª–∞–≤–Ω—ã–µ —Ü–∏—Ñ—Ä—ã</h2>

            <label>–°–∫–æ–ª—å–∫–æ –í–°–ï–ì–û –Ω–æ–≤—ã—Ö –ª–∏–¥–æ–≤ (–∑–∞—è–≤–æ–∫)?</label>
            <span class="help">Direct + WhatsApp + –ó–≤–æ–Ω–∫–∏</span>
            <input type="number" id="leads_count" placeholder="0" required>

            <br>
            <label>–û—Ç–∫—É–¥–∞ –±–æ–ª—å—à–µ –æ–±—Ä–∞—â–µ–Ω–∏–π?</label>
            <!-- Custom Select Implementation or Standard -->
            <select id="lead_source">
                <option value="Direct Instagram">Direct Instagram</option>
                <option value="WhatsApp / Taplink">WhatsApp / Taplink</option>
                <option value="–ö–æ–º–º–µ–Ω—Ç–∞—Ä–∏–∏">–ö–æ–º–º–µ–Ω—Ç–∞—Ä–∏–∏</option>
                <option value="–°–∞—Ä–∞—Ñ–∞–Ω–∫–∞">–°–∞—Ä–∞—Ñ–∞–Ω–∫–∞</option>
                <option value="–î—Ä—É–≥–æ–µ">–î—Ä—É–≥–æ–µ</option>
            </select>

            <br><br>
            <label>–°–∫–æ–ª—å–∫–æ –†–ï–ê–õ–¨–ù–´–• –ø—Ä–æ–¥–∞–∂?</label>
            <span class="help">–°–∫–æ–ª—å–∫–æ –ª—é–¥–µ–π –∑–∞–ø–ª–∞—Ç–∏–ª–∏ –¥–µ–Ω–µ–≥?</span>
            <input type="number" id="sales_count" placeholder="0" required>

            <br>
            <label>–°—Ä–µ–¥–Ω–∏–π —á–µ–∫ (–¢–µ–Ω–≥–µ)</label>
            <input type="text" id="average_check" placeholder="–ù–∞–ø—Ä: 15 000">
        </div>

        <!-- –ë–õ–û–ö 2: –ö–ê–ß–ï–°–¢–í–û -->
        <div class="card">
            <h2>2. –ö–∞—á–µ—Å—Ç–≤–æ –∞—É–¥–∏—Ç–æ—Ä–∏–∏</h2>
            <label>–û—Ü–µ–Ω–∫–∞ –∫–∞—á–µ—Å—Ç–≤–∞ –∑–∞—è–≤–æ–∫ (1-5)</label>
            <select id="quality_score">
                <option value="5">5 ‚Äî –ò–¥–µ–∞–ª—å–Ω—ã–µ –∫–ª–∏–µ–Ω—Ç—ã</option>
                <option value="4">4 ‚Äî –•–æ—Ä–æ—à–∏–µ</option>
                <option value="3">3 ‚Äî –ù–æ—Ä–º–∞–ª—å–Ω–æ</option>
                <option value="2">2 ‚Äî –ú–Ω–æ–≥–æ "–ø—É—Å—Ç—ã—Ö"</option>
                <option value="1">1 ‚Äî –°–ø–∞–º/–ú—É—Å–æ—Ä</option>
            </select>

            <br><br>
            <label>–ß—Ç–æ —á–∞—â–µ –≤—Å–µ–≥–æ –≥–æ–≤–æ—Ä—è—Ç –∫–ª–∏–µ–Ω—Ç—ã?</label>
            <span class="help">"–£–≤–∏–¥–µ–ª —Ä–∏–ª—Å", "–ü–æ—Å–æ–≤–µ—Ç–æ–≤–∞–ª–∏"...</span>
            <textarea id="client_source_quotes"></textarea>

            <br>
            <label>–ß–∞—Å—Ç—ã–µ –∂–∞–ª–æ–±—ã –∏–ª–∏ –≤–æ–ø—Ä–æ—Å—ã (–ë–æ–ª–∏)</label>
            <textarea id="customer_pain_points"></textarea>
        </div>

        <!-- –ë–õ–û–ö 3: –ü–†–û–¶–ï–°–°–´ -->
        <div class="card">
            <h2>3. –°–∫–æ—Ä–æ—Å—Ç—å –∏ –ü—Ä–æ—Ü–µ—Å—Å—ã</h2>
            <label>–ö–∞–∫ –±—ã—Å—Ç—Ä–æ –æ—Ç–≤–µ—á–∞–µ—Ç–µ –≤ Direct?</label>
            <select id="response_speed">
                <option value="5-15 –º–∏–Ω">‚ö° 5-15 –º–∏–Ω (–°—É–ø–µ—Ä)</option>
                <option value="1 —á–∞—Å">üïê –í —Ç–µ—á–µ–Ω–∏–µ —á–∞—Å–∞</option>
                <option value="–î–µ–Ω—å">üìÖ –í —Ç–µ—á–µ–Ω–∏–µ –¥–Ω—è</option>
                <option value="–î–æ–ª–≥–æ">üê¢ –ò–Ω–æ–≥–¥–∞ –ø—Ä–æ–ø—É—Å–∫–∞–µ–º</option>
            </select>

            <br><br>
            <label>–£–∑–Ω–∞–≤–∞–µ–º–æ—Å—Ç—å –±—Ä–µ–Ω–¥–∞ offline?</label>
            <select id="brand_awareness_offline">
                <option value="–î–∞, –≥–æ–≤–æ—Ä—è—Ç">–î–∞, –Ω–æ–≤—ã–µ –ª—é–¥–∏ –≥–æ–≤–æ—Ä—è—Ç –æ–± –ò–Ω—Å—Ç–µ</option>
                <option value="–ü–∞—Ä—Ç–Ω–µ—Ä—ã">–ü–∞—Ä—Ç–Ω–µ—Ä—ã —É–ø–æ–º–∏–Ω–∞—é—Ç</option>
                <option value="–ù–µ—Ç">–ü–æ–∫–∞ –Ω–µ –æ—â—É—â–∞—é</option>
            </select>
        </div>

        <!-- –ë–õ–û–ö 4: –ö–û–ù–¢–ï–ù–¢ -->
        <div class="card">
            <h2>4. –í–∑–≥–ª—è–¥ –≤–ª–∞–¥–µ–ª—å—Ü–∞</h2>
            <label>–ö–∞–∫–æ–π –∫–æ–Ω—Ç–µ–Ω—Ç –∑–∞—à–µ–ª –í–ê–ú –±–æ–ª—å—à–µ –≤—Å–µ–≥–æ?</label>
            <textarea id="favorite_content"></textarea>

            <br>
            <label>–ß–µ–≥–æ –Ω–µ —Ö–≤–∞—Ç–∞–µ—Ç?</label>
            <input type="text" id="missing_content_needs" placeholder="–ë–æ–ª—å—à–µ –ª–∞–π–≤–∞ / –ø–æ–ª—å–∑—ã / —ç—Å—Ç–µ—Ç–∏–∫–∏...">

            <br><br>
            <label>–û—â—É—â–µ–Ω–∏–µ –æ—Ö–≤–∞—Ç–∞ (1-5)</label>
            <span class="help">–ù–∞—Å–∫–æ–ª—å–∫–æ "–≥—Ä–æ–º–∫–æ" –º—ã –∑–≤—É—á–∏–º –≤ –≥–æ—Ä–æ–¥–µ?</span>
            <select id="reach_score">
                <option value="1">1</option>
                <option value="2">2</option>
                <option value="3">3</option>
                <option value="4">4</option>
                <option value="5">5</option>
            </select>
        </div>

        <!-- –ë–õ–û–ö 5: –ü–õ–ê–ù -->
        <div class="card">
            <h2>5. –ü–ª–∞–Ω –Ω–∞ –º–µ—Å—è—Ü</h2>
            <label>–ù–æ–≤—ã–µ –ø—Ä–æ–¥—É–∫—Ç—ã / –ê–∫—Ü–∏–∏?</label>
            <textarea id="new_campaigns"></textarea>

            <br>
            <label>–§–æ–∫—É—Å –Ω–∞ —Å–ª–µ–¥—É—é—â–∏–π –º–µ—Å—è—Ü?</label>
            <select id="next_month_focus">
                <option value="–õ–∏–¥—ã">üî• –ì–Ω–∞—Ç—å –∑–∞—è–≤–∫–∏ (–õ–∏–¥—ã)</option>
                <option value="–ò–º–∏–¥–∂">üíé –ò–º–∏–¥–∂ –∏ –î–æ—Ä–æ–≥–æ–π –≤–∏–∑—É–∞–ª</option>
                <option value="–ü–æ–¥–ø–∏—Å—á–∏–∫–∏">üë• –ù–∞–±–∏—Ä–∞—Ç—å –ø–æ–¥–ø–∏—Å—á–∏–∫–æ–≤</option>
                <option value="–û—Ö–≤–∞—Ç—ã">üì¢ –û—Ö–≤–∞—Ç—ã (–ü—Ä–æ—Å–º–æ—Ç—Ä—ã)</option>
            </select>

            <br><br>
            <label>–ü–æ–∂–µ–ª–∞–Ω–∏—è / –ò–¥–µ–∏</label>
            <textarea id="general_suggestions"></textarea>
        </div>

        <button type="button" class="btn" id="submitBtn">–û–¢–ü–†–ê–í–ò–¢–¨ –û–¢–ß–ï–¢ üöÄ</button>
    </form>

    <script>
        const S_URL = "https://waekzofajzqcpoeldhkt.supabase.co";
        const S_KEY = "sb_publishable_XVByRUkaKbM-11ChwOd2Aw_y24CSb4V";
        const supabase = window.supabase.createClient(S_URL, S_KEY);
        const tg = window.Telegram.WebApp;

        tg.expand();

        // Parse URL params
        const params = new URLSearchParams(window.location.search);
        const chatId = params.get('cid');
        const threadId = params.get('tid');

        document.getElementById('submitBtn').onclick = async () => {
            const btn = document.getElementById('submitBtn');
            btn.textContent = "–°–µ–∫—É–Ω–¥—É...";
            btn.disabled = true;

            const data = {
                instagram: document.getElementById('instagram').value,
                client_name: document.getElementById('client_name').value,
                phone: document.getElementById('phone').value,
                leads_count: document.getElementById('leads_count').value || 0,
                lead_source: document.getElementById('lead_source').value,
                sales_count: document.getElementById('sales_count').value || 0,
                average_check: document.getElementById('average_check').value,
                quality_score: document.getElementById('quality_score').value,
                client_source_quotes: document.getElementById('client_source_quotes').value,
                customer_pain_points: document.getElementById('customer_pain_points').value,
                response_speed: document.getElementById('response_speed').value,
                brand_awareness_offline: document.getElementById('brand_awareness_offline').value,
                favorite_content: document.getElementById('favorite_content').value,
                missing_content_needs: document.getElementById('missing_content_needs').value,
                reach_score: document.getElementById('reach_score').value,
                new_campaigns: document.getElementById('new_campaigns').value,
                next_month_focus: document.getElementById('next_month_focus').value,
                general_suggestions: document.getElementById('general_suggestions').value,
                chat_id: chatId,
                thread_id: threadId
            };

            // 1. Save to Supabase
            const { data: inserted, error } = await supabase
                .from('client_feedback')
                .insert(data)
                .select();

            if (error) {
                alert('–û—à–∏–±–∫–∞: ' + error.message);
                btn.textContent = "–ü–æ–ø—Ä–æ–±–æ–≤–∞—Ç—å —Å–Ω–æ–≤–∞";
                btn.disabled = false;
                return;
            }

            // 2. Trigger Backend Report
            try {
                // Using absolute URL because frontend is on GitHub Pages, backend on Vercel
                const resp = await fetch('https://media-seven-eta.vercel.app/api/report', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(inserted[0])
                });

                if (!resp.ok) {
                    console.error("Server error:", await resp.text());
                }
            } catch (err) {
                console.error("Report generation failed:", err);
            }

            tg.showAlert("–°–ø–∞—Å–∏–±–æ! –û—Ç—á–µ—Ç –æ—Ç–ø—Ä–∞–≤–ª–µ–Ω.");
            tg.close();

            tg.showAlert("–°–ø–∞—Å–∏–±–æ! –û—Ç—á–µ—Ç –æ—Ç–ø—Ä–∞–≤–ª–µ–Ω.");
            tg.close();
        };
    </script>
</body>

</html>