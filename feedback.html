<!DOCTYPE html>
<html lang="ru">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Campot Analytics | Feedback</title>
    <link rel="icon" type="image/png" href="favicon.png">
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://unpkg.com/react@18/umd/react.production.min.js"></script>
    <script src="https://unpkg.com/react-dom@18/umd/react-dom.production.min.js"></script>
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
    <script src="https://telegram.org/js/telegram-web-app.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;700;900&display=swap" rel="stylesheet">
    <style>
        body {
            background-color: #000;
            color: #fff;
            font-family: 'Inter', sans-serif;
        }

        .campot-red {
            color: #F92A1F;
        }

        .bg-campot-red {
            background-color: #F92A1F;
        }

        .border-campot-red {
            border-color: #F92A1F;
        }

        .input-style {
            background: #111;
            border: 1px solid #333;
            color: white;
            padding: 1rem;
            width: 100%;
            border-radius: 0;
            outline: none;
            transition: border-color 0.2s;
            font-size: 16px;
            /* Avoid iOS zoom */
        }

        .input-style:focus {
            border-color: #F92A1F;
        }

        .btn-campot {
            background: #F92A1F;
            color: #fff;
            font-weight: 900;
            text-transform: uppercase;
            padding: 1.25rem;
            width: 100%;
            transition: opacity 0.2s;
        }

        .btn-campot:active {
            opacity: 0.8;
        }

        .btn-campot:disabled {
            background: #333;
            color: #666;
        }

        .btn-secondary {
            border: 1px solid #333;
            color: #888;
            font-weight: 700;
            text-transform: uppercase;
            padding: 1rem;
            width: 100%;
            font-size: 0.8rem;
        }

        .step-anim {
            animation: fadeIn 0.4s ease-out;
        }

        @keyframes fadeIn {
            from {
                opacity: 0;
                transform: translateY(10px);
            }

            to {
                opacity: 1;
                transform: translateY(0);
            }
        }

        /* Custom Select Arrow */
        .select-wrapper {
            position: relative;
        }

        .select-wrapper::after {
            content: '‚ñº';
            font-size: 10px;
            color: #F92A1F;
            position: absolute;
            right: 15px;
            top: 50%;
            transform: translateY(-50%);
            pointer-events: none;
        }

        select.input-style {
            -webkit-appearance: none;
            appearance: none;
        }
    </style>
</head>

<body>
    <div id="root"></div>
    <script type="text/babel">
        const { useState, useEffect } = React;

        // Supabase Config
        const S_URL = "https://waekzofajzqcpoeldhkt.supabase.co";
        const S_KEY = "sb_publishable_XVByRUkaKbM-11ChwOd2Aw_y24CSb4V";
        const supabase = window.supabase.createClient(S_URL, S_KEY);
        const tg = window.Telegram.WebApp;

        // --- COMPONENTS DEFINED OUTSIDE APP TO PREVENT RE-RENDERS ---

        const Header = () => (
            <div className="mb-8">
                <h1 className="text-3xl font-black italic tracking-tighter uppercase">CAMPOT <span className="campot-red">ANALYTICS</span></h1>
                <div className="h-1 w-10 bg-campot-red mt-2"></div>
            </div>
        );

        const Step0_Contacts = ({ form, update, setStep }) => (
            <div className="step-anim space-y-6">
                <h2 className="text-sm font-bold uppercase tracking-[0.2em] text-zinc-500 border-l-2 border-campot-red pl-3 italic">01. –ö–æ–Ω—Ç–∞–∫—Ç—ã</h2>
                <input className="input-style" placeholder="Instagram @–∞–∫–∫–∞—É–Ω—Ç" value={form.instagram} onChange={e => update('instagram', e.target.value)} />
                <input className="input-style" placeholder="–í–∞—à–µ –ò–º—è" value={form.client_name} onChange={e => update('client_name', e.target.value)} />
                <input className="input-style" placeholder="–¢–µ–ª–µ—Ñ–æ–Ω" value={form.phone} onChange={e => update('phone', e.target.value)} />
                <button onClick={() => setStep(1)} disabled={!form.instagram} className="btn-campot">–î–∞–ª–µ–µ</button>
            </div>
        );

        const Step1_Metrics = ({ form, update, setStep }) => (
            <div className="step-anim space-y-6">
                <h2 className="text-sm font-bold uppercase tracking-[0.2em] text-zinc-500 border-l-2 border-campot-red pl-3 italic">02. –ú–µ—Ç—Ä–∏–∫–∏</h2>
                <div>
                    <label className="text-[10px] uppercase text-zinc-500 mb-1 block">–ù–æ–≤—ã—Ö –ª–∏–¥–æ–≤ –∑–∞ –º–µ—Å—è—Ü</label>
                    <input className="input-style" type="number" placeholder="0" value={form.leads_count} onChange={e => update('leads_count', e.target.value)} />
                </div>
                <div>
                    <label className="text-[10px] uppercase text-zinc-500 mb-1 block">–û—Å–Ω–æ–≤–Ω–æ–π –∏—Å—Ç–æ—á–Ω–∏–∫</label>
                    <div className="select-wrapper">
                        <select className="input-style" value={form.lead_source} onChange={e => update('lead_source', e.target.value)}>
                            <option value="Direct Instagram">Direct Instagram</option>
                            <option value="WhatsApp / Taplink">WhatsApp / Taplink</option>
                            <option value="–ö–æ–º–º–µ–Ω—Ç–∞—Ä–∏–∏">–ö–æ–º–º–µ–Ω—Ç–∞—Ä–∏–∏</option>
                            <option value="–°–∞—Ä–∞—Ñ–∞–Ω–∫–∞">–°–∞—Ä–∞—Ñ–∞–Ω–∫–∞</option>
                            <option value="–î—Ä—É–≥–æ–µ">–î—Ä—É–≥–æ–µ</option>
                        </select>
                    </div>
                </div>
                <div>
                    <label className="text-[10px] uppercase text-zinc-500 mb-1 block">–†–µ–∞–ª—å–Ω—ã—Ö –ø—Ä–æ–¥–∞–∂ (—à—Ç)</label>
                    <input className="input-style" type="number" placeholder="0" value={form.sales_count} onChange={e => update('sales_count', e.target.value)} />
                </div>
                <div>
                    <label className="text-[10px] uppercase text-zinc-500 mb-1 block">–°—Ä–µ–¥–Ω–∏–π —á–µ–∫</label>
                    <input className="input-style" placeholder="–ù–∞–ø—Ä: 15 000" value={form.average_check} onChange={e => update('average_check', e.target.value)} />
                </div>
                <div className="flex gap-3 pt-4">
                    <button onClick={() => setStep(0)} className="btn-secondary w-1/3">–ù–∞–∑–∞–¥</button>
                    <button onClick={() => setStep(2)} className="btn-campot flex-1">–î–∞–ª–µ–µ</button>
                </div>
            </div>
        );

        const Step2_Quality = ({ form, update, setStep }) => (
            <div className="step-anim space-y-6">
                <h2 className="text-sm font-bold uppercase tracking-[0.2em] text-zinc-500 border-l-2 border-campot-red pl-3 italic">03. –ö–∞—á–µ—Å—Ç–≤–æ</h2>

                <div className="space-y-4">
                    <label className="text-[10px] uppercase text-zinc-600 block">–û—Ü–µ–Ω–∫–∞ –∫–∞—á–µ—Å—Ç–≤–∞ –∑–∞—è–≤–æ–∫ (1-5)</label>
                    <div className="flex justify-between gap-1">
                        {[1, 2, 3, 4, 5].map(v => (
                            <button key={v} onClick={() => update('quality_score', v)}
                                className={`flex-1 p-3 font-bold border ${form.quality_score === v ? 'bg-campot-red text-white border-campot-red' : 'border-zinc-800 text-zinc-600'}`}>
                                {v}
                            </button>
                        ))}
                    </div>
                </div>

                <textarea className="input-style h-24" placeholder="–ß—Ç–æ –≥–æ–≤–æ—Ä—è—Ç –∫–ª–∏–µ–Ω—Ç—ã? (–¶–∏—Ç–∞—Ç—ã)" value={form.client_source_quotes} onChange={e => update('client_source_quotes', e.target.value)}></textarea>
                <textarea className="input-style h-24" placeholder="–ñ–∞–ª–æ–±—ã –∏–ª–∏ —á–∞—Å—Ç—ã–µ –≤–æ–ø—Ä–æ—Å—ã" value={form.customer_pain_points} onChange={e => update('customer_pain_points', e.target.value)}></textarea>

                <div className="flex gap-3 pt-4">
                    <button onClick={() => setStep(1)} className="btn-secondary w-1/3">–ù–∞–∑–∞–¥</button>
                    <button onClick={() => setStep(3)} className="btn-campot flex-1">–î–∞–ª–µ–µ</button>
                </div>
            </div>
        );

        const Step3_Process = ({ form, update, setStep }) => (
            <div className="step-anim space-y-6">
                <h2 className="text-sm font-bold uppercase tracking-[0.2em] text-zinc-500 border-l-2 border-campot-red pl-3 italic">04. –ü—Ä–æ—Ü–µ—Å—Å—ã</h2>

                <div>
                    <label className="text-[10px] uppercase text-zinc-500 mb-1 block">–°–∫–æ—Ä–æ—Å—Ç—å –æ—Ç–≤–µ—Ç–∞ –≤ Direct</label>
                    <div className="select-wrapper">
                        <select className="input-style" value={form.response_speed} onChange={e => update('response_speed', e.target.value)}>
                            <option value="5-15 –º–∏–Ω">‚ö° 5-15 –º–∏–Ω (–°—É–ø–µ—Ä)</option>
                            <option value="1 —á–∞—Å">üïê –í —Ç–µ—á–µ–Ω–∏–µ —á–∞—Å–∞</option>
                            <option value="–î–µ–Ω—å">üìÖ –í —Ç–µ—á–µ–Ω–∏–µ –¥–Ω—è</option>
                            <option value="–î–æ–ª–≥–æ">üê¢ –ò–Ω–æ–≥–¥–∞ –ø—Ä–æ–ø—É—Å–∫–∞–µ–º</option>
                        </select>
                    </div>
                </div>

                <div>
                    <label className="text-[10px] uppercase text-zinc-500 mb-1 block">–£–∑–Ω–∞–≤–∞–µ–º–æ—Å—Ç—å Offline</label>
                    <div className="select-wrapper">
                        <select className="input-style" value={form.brand_awareness_offline} onChange={e => update('brand_awareness_offline', e.target.value)}>
                            <option value="–î–∞, –≥–æ–≤–æ—Ä—è—Ç">üó£ –î–∞, –≥–æ–≤–æ—Ä—è—Ç –æ–± –ò–Ω—Å—Ç–∞–≥—Ä–∞–º</option>
                            <option value="–ü–∞—Ä—Ç–Ω–µ—Ä—ã">ü§ù –£–ø–æ–º–∏–Ω–∞—é—Ç –ø–∞—Ä—Ç–Ω–µ—Ä—ã</option>
                            <option value="–ù–µ—Ç">üò∂ –ü–æ–∫–∞ —Ç–∏—Ö–æ</option>
                        </select>
                    </div>
                </div>

                <div className="flex gap-3 pt-4">
                    <button onClick={() => setStep(2)} className="btn-secondary w-1/3">–ù–∞–∑–∞–¥</button>
                    <button onClick={() => setStep(4)} className="btn-campot flex-1">–î–∞–ª–µ–µ</button>
                </div>
            </div>
        );

        const Step4_Content = ({ form, update, setStep }) => (
            <div className="step-anim space-y-6">
                <h2 className="text-sm font-bold uppercase tracking-[0.2em] text-zinc-500 border-l-2 border-campot-red pl-3 italic">05. –ö–æ–Ω—Ç–µ–Ω—Ç</h2>
                <textarea className="input-style h-20" placeholder="–ö–∞–∫–æ–π –∫–æ–Ω—Ç–µ–Ω—Ç –ø–æ–Ω—Ä–∞–≤–∏–ª—Å—è –í–ê–ú?" value={form.favorite_content} onChange={e => update('favorite_content', e.target.value)}></textarea>
                <input className="input-style" placeholder="–ß–µ–≥–æ –Ω–µ —Ö–≤–∞—Ç–∞–µ—Ç? (–õ–∞–π–≤ / –ü–æ–ª—å–∑–∞)" value={form.missing_content_needs} onChange={e => update('missing_content_needs', e.target.value)} />

                <div className="space-y-4">
                    <label className="text-[10px] uppercase text-zinc-600 block">–û—Ö–≤–∞—Ç –∏ —à—É–º –≤ –≥–æ—Ä–æ–¥–µ (1-5)</label>
                    <div className="flex justify-between gap-1">
                        {[1, 2, 3, 4, 5].map(v => (
                            <button key={v} onClick={() => update('reach_score', v)}
                                className={`flex-1 p-3 font-bold border ${form.reach_score === v ? 'bg-campot-red text-white border-campot-red' : 'border-zinc-800 text-zinc-600'}`}>
                                {v}
                            </button>
                        ))}
                    </div>
                </div>

                <div className="flex gap-3 pt-4">
                    <button onClick={() => setStep(3)} className="btn-secondary w-1/3">–ù–∞–∑–∞–¥</button>
                    <button onClick={() => setStep(5)} className="btn-campot flex-1">–î–∞–ª–µ–µ</button>
                </div>
            </div>
        );

        const Step5_Plan = ({ form, update, setStep, submit, loading, errorMsg }) => (
            <div className="step-anim space-y-6">
                <h2 className="text-sm font-bold uppercase tracking-[0.2em] text-zinc-500 border-l-2 border-campot-red pl-3 italic">06. –ü–ª–∞–Ω</h2>

                <textarea className="input-style h-24" placeholder="–ù–æ–≤—ã–µ –∞–∫—Ü–∏–∏ / –ü—Ä–æ–¥—É–∫—Ç—ã?" value={form.new_campaigns} onChange={e => update('new_campaigns', e.target.value)}></textarea>

                <div>
                    <label className="text-[10px] uppercase text-zinc-500 mb-1 block">–ì–ª–∞–≤–Ω—ã–π —Ñ–æ–∫—É—Å –º–µ—Å—è—Ü–∞</label>
                    <div className="select-wrapper">
                        <select className="input-style" value={form.next_month_focus} onChange={e => update('next_month_focus', e.target.value)}>
                            <option value="–õ–∏–¥—ã">üî• –õ–∏–¥—ã (–ó–∞—è–≤–∫–∏)</option>
                            <option value="–ò–º–∏–¥–∂">üíé –ò–º–∏–¥–∂ / –í–∏–∑—É–∞–ª</option>
                            <option value="–ü–æ–¥–ø–∏—Å—á–∏–∫–∏">üë• –ü–æ–¥–ø–∏—Å—á–∏–∫–∏</option>
                            <option value="–û—Ö–≤–∞—Ç—ã">üì¢ –û—Ö–≤–∞—Ç—ã</option>
                        </select>
                    </div>
                </div>

                <textarea className="input-style h-24" placeholder="–ü–æ–∂–µ–ª–∞–Ω–∏—è –∏ –∏–¥–µ–∏ –¥–ª—è –Ω–∞—Å?" value={form.general_suggestions} onChange={e => update('general_suggestions', e.target.value)}></textarea>

                {errorMsg && <div className="p-3 bg-red-900/30 border border-red-500 text-red-200 text-xs">{errorMsg}</div>}

                <div className="flex gap-3 pt-4">
                    <button onClick={() => setStep(4)} className="btn-secondary w-1/3">–ù–∞–∑–∞–¥</button>
                    <button onClick={submit} disabled={loading} className="btn-campot flex-1">
                        {loading ? "–û—Ç–ø—Ä–∞–≤–∫–∞..." : "–û–¢–ü–†–ê–í–ò–¢–¨ –û–¢–ß–ï–¢ üöÄ"}
                    </button>
                </div>
            </div>
        );

        // --- MAIN APP COMPONENT ---

        const App = () => {
            const [step, setStep] = useState(0);
            const [loading, setLoading] = useState(false);
            const [errorMsg, setErrorMsg] = useState("");

            // Initial data from URL
            const params = new URLSearchParams(window.location.search);
            const [form, setForm] = useState({
                // Block 0
                instagram: '', client_name: '', phone: '',
                // Block 1
                leads_count: '', lead_source: 'Direct Instagram', sales_count: '', average_check: '',
                // Block 2
                quality_score: 5, client_source_quotes: '', customer_pain_points: '',
                // Block 3
                response_speed: '5-15 –º–∏–Ω', brand_awareness_offline: '–ù–µ—Ç',
                // Block 4
                favorite_content: '', missing_content_needs: '', reach_score: 3,
                // Block 5
                new_campaigns: '', next_month_focus: '–õ–∏–¥—ã', general_suggestions: '',
                // Meta
                chat_id: params.get('cid'), thread_id: params.get('tid')
            });

            // Prevent zoom on focus for iOS
            useEffect(() => {
                const metaViewport = document.querySelector('meta[name=viewport]');
                metaViewport.setAttribute('content', 'width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no');
            }, []);

            useEffect(() => {
                tg.expand();
                tg.MainButton.hide();
            }, []);

            const update = (field, value) => {
                setForm(prev => ({ ...prev, [field]: value }));
            };

            const submit = async () => {
                setLoading(true);
                setErrorMsg("");
                try {
                    // 1. Insert to Supabase
                    const { data: inserted, error } = await supabase
                        .from('client_feedback')
                        .insert(form)
                        .select();

                    if (error) throw new Error(error.message);

                    // 2. Trigger Backend Report (Vercel)
                    const backendUrl = "https://media-seven-eta.vercel.app/api/report";
                    const resp = await fetch(backendUrl, {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify(inserted[0])
                    });

                    if (!resp.ok) {
                        const txt = await resp.text();
                        console.error("Backend Error:", txt);
                    }

                    setStep(100); // Success screen
                    tg.HapticFeedback.notificationOccurred('success');

                } catch (e) {
                    tg.HapticFeedback.notificationOccurred('error');
                    setErrorMsg("–û—à–∏–±–∫–∞: " + e.message);
                }
                setLoading(false);
            };

            if (step === 100) return (
                <div className="min-h-screen flex flex-col items-center justify-center p-8 text-center bg-black">
                    <div className="text-6xl mb-6 animate-bounce">‚úÖ</div>
                    <h2 className="text-2xl font-black italic text-white mb-4 uppercase">–î–∞–Ω–Ω—ã–µ –ø—Ä–∏–Ω—è—Ç—ã</h2>
                    <p className="text-zinc-500 text-sm tracking-widest uppercase">–ö–æ–º–∞–Ω–¥–∞ Campot Media —É–∂–µ –ø–æ–ª—É—á–∏–ª–∞ –≤–∞—à –æ—Ç—á–µ—Ç.</p>
                    <div className="mt-10 text-[10px] text-zinc-700 uppercase">–ú–æ–∂–Ω–æ –∑–∞–∫—Ä—ã—Ç—å –≤–∫–ª–∞–¥–∫—É</div>
                </div>
            );

            return (
                <div className="max-w-md mx-auto min-h-screen p-6 flex flex-col justify-center">
                    <Header />
                    {step === 0 && <Step0_Contacts form={form} update={update} setStep={setStep} />}
                    {step === 1 && <Step1_Metrics form={form} update={update} setStep={setStep} />}
                    {step === 2 && <Step2_Quality form={form} update={update} setStep={setStep} />}
                    {step === 3 && <Step3_Process form={form} update={update} setStep={setStep} />}
                    {step === 4 && <Step4_Content form={form} update={update} setStep={setStep} />}
                    {step === 5 && <Step5_Plan form={form} update={update} setStep={setStep} submit={submit} loading={loading} errorMsg={errorMsg} />}

                    <footer className="mt-20 text-center opacity-30">
                        <p className="text-[8px] uppercase tracking-[4px]">Campot Analytics / 2026</p>
                    </footer>
                </div>
            );
        };

        const root = ReactDOM.createRoot(document.getElementById('root'));
        root.render(<App />);
    </script>
</body>

</html>